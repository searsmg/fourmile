---
title: "Fourmile Calibrations"
author: "Megan Sears"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: journal
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(plotly)
library(lubridate)
library(knitr)
library(kableExtra)
library(dataRetrieval)
library(hydroGOF)
library(sp)
library(raster)
library(sf)
library(mapview)
library(here)
library(scales)
library(dataRetrieval)

```

```{r load in files, include = F}

kge <- read_csv('calruns_KGE.csv')

# #these are old -- no longer in use
# params <- read_csv('calruns_params.csv') %>%
#   drop_na()

```

# KGE for calibrations

```{r look at kge, echo = F}

kge_plot <- ggplot(kge, aes(year_missing, KGE, shape = input_data, color = input_data)) + geom_point(size = 3) +
  theme_bw()

ggplotly(kge_plot)

```

# Parameters

## Scatter plots

```{r params, echo = F}

# params <- params %>%
#   mutate(input_data = case_when(
#     grepl('station', run) ~ 'station',
#     grepl('grid', run) ~ 'grid'
#   )) %>%
#   mutate(year_missing_almost = gsub('station_|grid_', '', run)) %>%
#   mutate(year_missing = gsub('all', 'none', year_missing_almost)) %>%
#   select(-c(year_missing_almost)) %>%
#   filter(!param == 'locGrw',
#          !param == 'tempRes') %>%
#   mutate(value = as.numeric(value),
#          param = as.factor(param))

# write_csv(params, 'paramsnew.csv')

params <- read_csv('paramsnew.csv') %>%
  mutate(value = as.numeric(value),
         param = as.factor(param))
  

#function to plot all params
plot_params <- function(param_name) {
  params %>%
    filter(param == param_name) %>%
    ggplot(aes(x = year_missing,
               y = value,
               shape = input_data, 
               color = input_data)) + 
    geom_point(size = 3) + 
    ggtitle(param_name) +
    theme_bw()
}

name <- levels(params$param)

lapply(name, plot_params)

#write.csv(params, 'params.csv')

```

## Histograms

```{r density plots, echo = F}

mean_params <- params %>%
  group_by(param, input_data) %>%
  summarize(mean = mean(value))

plotdens_params <- function(param_name) {
  params %>%
    filter(param == param_name) %>%
    ggplot(aes(x = value,
               fill = input_data, 
               color = input_data)) + 
    geom_histogram(position="identity", alpha=0.5) +
    geom_vline(data=filter(mean_params, param == param_name), 
               aes(xintercept=mean, color=input_data),
             linetype="dashed", size=0.75) +
    ggtitle(param_name) +
    theme_bw()
}

name <- levels(params$param)

lapply(name, plotdens_params)

```

# Outlet results

```{r map, echo = F}

locations <- read_csv(here('data/GIS', 'fourmile_sensors.csv'))

hrus <- st_read(here('data/GIS', 'hrus_final.shp'))

locations <- locations %>%
  st_as_sf(., coords=c('y','x'), crs = 4326)

mapviewOptions(basemaps = c("Esri.WorldShadedRelief", "OpenStreetMap.DE"),
               layers.control.pos = "topright")

mapview(locations, zcol = 'type') + mapview(hrus)

```

## Hydrograph

```{r hydrographs, echo = F}
flow <- read_csv('discharge_all.csv') %>%
  replace(.==-9999, NA)


flow_pivot <- flow %>%
  pivot_longer(!date, names_to = 'cal_run', values_to = 'q_m3s') %>%
  mutate(year = as.factor(year(date)))


q <- ggplot(flow_pivot, aes(date, q_m3s, color = cal_run)) +
  geom_line() +
  scale_color_manual(name="cal_run", values=c('obs' = 'black',
                                            "grid_2011"="seagreen", 
                                            "grid_2012"="seagreen2", 
                                            "grid_2013"="steelblue",
                                            "grid_2014"='dodgerblue', 
                                            "grid_2015" = "cyan3",
                                            'grid_2016' = 'blue',
                                            'grid_2017' = 'blue4',
                                            'grid_2018' = 'cadetblue',
                                            'grid_2019' = 'lightgreen',
                                            'grid_2020' = 'olivedrab',
                                            'grid_all' = 'steelblue3',
                                            "statn_2011"="maroon", 
                                            "statn_2012"="deeppink4", 
                                            "statn_2013"="deeppink",
                                            "statn_2014"='purple', 
                                            "statn_2015" = "mediumorchid1",
                                            'statn_2016' = 'indianred',
                                            'statn_2017' = 'sienna',
                                            'statn_2018' = 'salmon2',
                                            'statn_2019' = 'mediumpurple1',
                                            'statn_2020' = 'violetred',
                                            'statn_all' = 'red')) 

ggplotly(q)

```

## Annual hydrographs

```{r cy hydrographs, echo = F}

plotq_cy <- function(calyear) {
  {flow_pivot %>%
    filter(year == calyear) %>%
    ggplot(aes(x = date,
               y = q_m3s,
               color = cal_run)) +
    geom_line() +
        scale_color_manual(name="cal_run", values=c('obs' = 'black',
                                            "grid_2011"="seagreen", 
                                            "grid_2012"="seagreen2", 
                                            "grid_2013"="steelblue",
                                            "grid_2014"='dodgerblue', 
                                            "grid_2015" = "cyan3",
                                            'grid_2016' = 'blue',
                                            'grid_2017' = 'blue4',
                                            'grid_2018' = 'cadetblue',
                                            'grid_2019' = 'lightgreen',
                                            'grid_2020' = 'olivedrab',
                                            'grid_all' = 'steelblue3',
                                            "statn_2011"="maroon", 
                                            "statn_2012"="deeppink4", 
                                            "statn_2013"="deeppink",
                                            "statn_2014"='purple', 
                                            "statn_2015" = "mediumorchid1",
                                            'statn_2016' = 'indianred',
                                            'statn_2017' = 'sienna',
                                            'statn_2018' = 'salmon2',
                                            'statn_2019' = 'mediumpurple1',
                                            'statn_2020' = 'violetred',
                                            'statn_all' = 'red')) +
    ggtitle(calyear) +
    theme_bw()} %>%
    ggplotly()

}

name <- levels(flow_pivot$year)

try <- lapply(name, plotq_cy)

htmltools::tagList(try)

try
```

## KGE

### Overall KGE

```{r kge overall, echo = F}

flow_kge_all <- flow %>%
  summarize(grid2011 = KGE(grid_2011, obs),
            grid2012 = KGE(grid_2012, obs),
            grid2013 = KGE(grid_2013, obs),
            grid2014 = KGE(grid_2014, obs),
            grid2015 = KGE(grid_2015, obs),
            grid2016 = KGE(grid_2016, obs),
            grid2017 = KGE(grid_2017, obs),
            grid2018 = KGE(grid_2018, obs),
            grid2019 = KGE(grid_2019, obs),
            grid2020 = KGE(grid_2020, obs),
            gridall = KGE(grid_all, obs),
            statn2011 = KGE(statn_2011, obs),
            statn2012 = KGE(statn_2012, obs),
            statn2013 = KGE(statn_2013, obs),
            statn2014 = KGE(statn_2014, obs),
            statn2015 = KGE(statn_2015, obs),
            statn2016 = KGE(statn_2016, obs),
            statn2017 = KGE(statn_2017, obs),
            statn2018 = KGE(statn_2018, obs),
            statn2019 = KGE(statn_2019, obs),
            statn2020 = KGE(statn_2020, obs),
            statnall = KGE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

flow_kge_all <- flow_kge_all %>%
  pivot_longer(everything()) %>%
  arrange(value)

kable(flow_kge_all) %>%
  kable_styling(full_width = F)

```

### KGE by year

```{r kge by year, echo = F}

flow_year <- flow %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(grid2011 = KGE(grid_2011, obs),
            grid2012 = KGE(grid_2012, obs),
            grid2013 = KGE(grid_2013, obs),
            grid2014 = KGE(grid_2014, obs),
            grid2015 = KGE(grid_2015, obs),
            grid2016 = KGE(grid_2016, obs),
            grid2017 = KGE(grid_2017, obs),
            grid2018 = KGE(grid_2018, obs),
            grid2019 = KGE(grid_2019, obs),
            grid2020 = KGE(grid_2020, obs),
            gridall = KGE(grid_all, obs),
            statn2011 = KGE(statn_2011, obs),
            statn2012 = KGE(statn_2012, obs),
            statn2013 = KGE(statn_2013, obs),
            statn2014 = KGE(statn_2014, obs),
            statn2015 = KGE(statn_2015, obs),
            statn2016 = KGE(statn_2016, obs),
            statn2017 = KGE(statn_2017, obs),
            statn2018 = KGE(statn_2018, obs),
            statn2019 = KGE(statn_2019, obs),
            statn2020 = KGE(statn_2020, obs),
            statnall = KGE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

flow_kge <- flow_year %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'kge') %>%
  pivot_wider(names_from = 'year', values_from = 'kge')

flow_kge %>%
  kable(.) %>%
  kable_styling()


flow_plot <- flow_year %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'kge') %>%
  mutate(year = as.factor(year))


kge_plot_cy <- ggplot(flow_plot, aes(year, kge, color = model_run)) + 
  geom_point(size = 3) +
  scale_color_manual(name="model_run", values=c("grid2011"="seagreen", 
                                            "grid2012"="seagreen2", 
                                            "grid2013"="steelblue",
                                            "grid2014"='dodgerblue', 
                                            "grid2015" = "cyan3",
                                            'grid2016' = 'blue',
                                            'grid2017' = 'blue4',
                                            'grid2018' = 'cadetblue',
                                            'grid2019' = 'lightgreen',
                                            'grid2020' = 'olivedrab',
                                            'gridall' = 'steelblue3',
                                            "statn2011"="maroon", 
                                            "statn2012"="deeppink4", 
                                            "statn2013"="deeppink",
                                            "statn2014"='purple', 
                                            "statn2015" = "mediumorchid1",
                                            'statn2016' = 'indianred',
                                            'statn2017' = 'sienna',
                                            'statn2018' = 'salmon2',
                                            'statn2019' = 'mediumpurple1',
                                            'statn2020' = 'violetred',
                                            'statnall' = 'red')) +
  theme_bw()

ggplotly(kge_plot_cy)


```

### Annual KGE plots

```{r wy plots, echo = F}

plot_kge <- function(calyear) {
  flow_plot %>%
    filter(year == calyear) %>%
    ggplot(aes(x = model_run,
               y = kge)) +
    geom_col() +
    ggtitle(calyear) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1))
}

name <- levels(flow_plot$year)

lapply(name, plot_kge)

```

# Ensembles

## Hydrograph

```{r boulder cr gage, echo = F}

#pull in Boulder Creek @ N 75th gage

bouldcr <- readNWISdv(siteNumbers = "06730200",
                          parameterCd = "00060", 
                          startDate = "2011-01-01", 
                          endDate = "2020-12-31")  %>%
  select(date = Date,
         q_cfs = X_00060_00003) %>%
  mutate(bouldcr = q_cfs/35.3146662) %>%
  select(-q_cfs) %>%
  mutate(year = year(date))

```


```{r ensemble hydrographs, echo = F}

ensem <- flow %>%
  rowwise() %>%
  mutate(grid_ensemble = mean(c(grid_2011, grid_2012,
                                grid_2013, grid_2014,
                                grid_2015, grid_2016,
                                grid_2017, grid_2018,
                                grid_2019, grid_2020)),
         statn_ensemble = mean(c(statn_2011, statn_2012,
                                 statn_2013, statn_2014,
                                 statn_2015, statn_2016,
                                 statn_2017, statn_2018,
                                 statn_2019, statn_2020)),
         all_ensemble = mean(c(grid_2011, grid_2012,
                               grid_2013, grid_2014,
                               grid_2015, grid_2016,
                               grid_2017, grid_2018,
                               grid_2019, grid_2020,
                               statn_2011, statn_2012,
                               statn_2013, statn_2014,
                               statn_2015, statn_2016,
                               statn_2017, statn_2018,
                               statn_2019, statn_2020,
                               grid_all, statn_all))) %>%
  select(date, grid_ensemble, statn_ensemble, 
         all_ensemble, grid_all, 
         statn_all, obs) 

ensem_pivot <- ensem %>%
  pivot_longer(!date, names_to = 'cal_run', values_to = 'q_m3s') %>%
  mutate(year = as.factor(year(date)))


q_ensemble <- ggplot(ensem_pivot, aes(date, q_m3s, color = cal_run)) +
  geom_line() +
  scale_color_manual(name="cal_run", values=c('obs'='black',
                                            "grid_ensemble"="maroon", 
                                            "statn_ensemble"="darkturquoise", 
                                            "grid_all"="purple1",
                                            "statn_all"='springgreen4', 
                                            "all_ensemble" = "orange")) +
  geom_line(data = bouldcr, aes(date, bouldcr/10), color = 'darkgrey') +
  scale_y_continuous(name = 'Q_m3s',
                    sec.axis = sec_axis(~.*10, name='BoulderCr_cms')) +
  theme_bw()


ggplotly(q_ensemble) %>%
  add_lines(data=bouldcr, x=~date, y=~bouldcr, colors=NULL, yaxis="y2", 
              inherit=FALSE, showlegend = FALSE) %>%
  layout(yaxis2 = list(overlaying = "y", side = "right",
                       color = 'darkgray',
                       title = "BoulderCr_cms"),
         legend = list(x = 1.1, y = 0.95))

```

## Annual hydrographs

```{r hydrogs by cy, echo = F}

plotqensem_cy <- function(calyear) {
  {ensem_pivot %>%
    filter(year == calyear) %>%
    ggplot(aes(x = date,
               y = q_m3s,
               color = cal_run)) +
    geom_line() +
    scale_color_manual(name="cal_run", values=c('obs' = 'black',
                                            "grid_ensemble"="maroon", 
                                            "statn_ensemble"="darkturquoise", 
                                            "grid_all"="purple1",
                                            "statn_all"='springgreen4', 
                                            "all_ensemble" = "orange")) +
    ggtitle(calyear) +
    theme_bw()
    } %>%
    ggplotly()
}

name <- levels(ensem_pivot$year)

try <- lapply(name, plotqensem_cy)

htmltools::tagList(try)

try

```

## KGE

### KGE for ensembles (entire period)

```{r ensemble kge, echo = F}

ensem_kge_all <- ensem %>%
  ungroup() %>%
  summarize(grid_ensemble = KGE(grid_ensemble, obs),
            statn_ensemble = KGE(statn_ensemble, obs),
            all_ensemble = KGE(all_ensemble, obs),
            grid_all = KGE(grid_all, obs),
            statn_all = KGE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

kable(ensem_kge_all) %>%
  kable_styling(full_width = F)


```

### Annual KGEs for ensembles

```{r annual kge ensemble, echo = F}

yr_kge_ensem <- ensem %>%
  ungroup() %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(grid_ensemble = KGE(grid_ensemble, obs),
            statn_ensemble = KGE(statn_ensemble, obs),
            all_ensemble = KGE(all_ensemble, obs),
            grid_all = KGE(grid_all, obs),
            statn_all = KGE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

yr_kge_table <- yr_kge_ensem %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'kge') %>%
  pivot_wider(names_from = 'year', values_from = 'kge')

yr_kge_table %>%
  kable(.) %>%
  kable_styling()

yr_kge_plot <- yr_kge_ensem %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'kge') %>%
  mutate(year = as.factor(year))

#plot annual kge vals for ensembles
plot_kge_yr_ensem <- function(calyear) {
  yr_kge_plot %>%
    filter(year == calyear) %>%
    ggplot(aes(x = model_run,
               y = kge)) +
    geom_col() +
    ggtitle(calyear) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1))
}

name <- levels(yr_kge_plot$year)

lapply(name, plot_kge_yr_ensem)


```

### Monthly KGEs for ensembles

```{r monthly kge ensemble, echo = F}

mo_kge <- ensem %>%
  ungroup() %>%
  drop_na() %>% 
  mutate(month = month(date)) %>%
  group_by(month) %>%
  summarize(grid_ensemble = KGE(grid_ensemble, obs),
            statn_ensemble = KGE(statn_ensemble, obs),
            all_ensemble = KGE(all_ensemble, obs),
            grid_all = KGE(grid_all, obs),
            statn_all = KGE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

kable(mo_kge) %>%
  kable_styling(full_width = F)

mo_pivot <- mo_kge %>%
  pivot_longer(!month, names_to = 'cal_run', values_to = 'KGE') %>%
  drop_na()

kge_plot_mo <- ggplot(mo_pivot, aes(month, KGE, color = cal_run)) + geom_point(size = 3) +
    scale_color_manual(name="cal_run", values=c("grid_ensemble"="maroon", 
                                            "statn_ensemble"="darkturquoise", 
                                            "grid_all"="purple1",
                                            "statn_all"='springgreen4', 
                                            "all_ensemble" = "orange")) +
  theme_bw()

ggplotly(kge_plot_mo)

```

## RMSE

### Ensemble RMSE for entire period

```{r ensemble rmse, echo = F}

ensem_rmse_all <- ensem %>%
  ungroup() %>%
  summarize(grid_ensemble = rmse(grid_ensemble, obs),
            statn_ensemble = rmse(statn_ensemble, obs),
            all_ensemble = rmse(all_ensemble, obs),
            grid_all = rmse(grid_all, obs),
            statn_all = rmse(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 4)

kable(ensem_rmse_all) %>%
  kable_styling(full_width = F)

```

### Annual RMSE for ensembles

```{r annual rmse ensem, echo = F}

yr_rmse_ensem <- ensem %>%
  ungroup() %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(grid_ensemble = rmse(grid_ensemble, obs),
            statn_ensemble = rmse(statn_ensemble, obs),
            all_ensemble = rmse(all_ensemble, obs),
            grid_all = rmse(grid_all, obs),
            statn_all = rmse(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 4)

yr_rmse_table <- yr_rmse_ensem %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'rmse') %>%
  pivot_wider(names_from = 'year', values_from = 'rmse')

yr_rmse_table %>%
  kable(.) %>%
  kable_styling()

yr_rmse_plot <- yr_rmse_ensem %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'rmse') %>%
  mutate(year = as.factor(year))

#plot annual rmse vals for ensembles
plot_rmse_yr_ensem <- function(calyear) {
  yr_rmse_plot %>%
    filter(year == calyear) %>%
    ggplot(aes(x = model_run,
               y = rmse)) +
    geom_col() +
    ggtitle(calyear) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1))
}

name <- levels(yr_rmse_plot$year)

lapply(name, plot_rmse_yr_ensem)


```

### Monthly RMSEs for ensembles

```{r month ensem rmse, echo = F}

mo_rmse <- ensem %>%
  ungroup() %>%
  drop_na() %>% 
  mutate(month = month(date)) %>%
  group_by(month) %>%
  summarize(grid_ensemble = rmse(grid_ensemble, obs),
            statn_ensemble = rmse(statn_ensemble, obs),
            all_ensemble = rmse(all_ensemble, obs),
            grid_all = rmse(grid_all, obs),
            statn_all = rmse(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 4)

kable(mo_rmse) %>%
  kable_styling(full_width = F)

mo_pivot2 <- mo_rmse %>%
  pivot_longer(!month, names_to = 'cal_run', values_to = 'RMSE') %>%
  drop_na()

rmse_plot_mo <- ggplot(mo_pivot2, aes(month, RMSE, color = cal_run)) + geom_point(size = 3) +
    scale_color_manual(name="cal_run", values=c("grid_ensemble"="maroon", 
                                            "statn_ensemble"="darkturquoise", 
                                            "grid_all"="purple1",
                                            "statn_all"='springgreen4', 
                                            "all_ensemble" = "orange")) +
  theme_bw()

ggplotly(rmse_plot_mo)

```

## NSE

### Ensemble NSE for entire period

```{r nse all, echo = F}

ensem_nse_all <- ensem %>%
  ungroup() %>%
  summarize(grid_ensemble = NSE(grid_ensemble, obs),
            statn_ensemble = NSE(statn_ensemble, obs),
            all_ensemble = NSE(all_ensemble, obs),
            grid_all = NSE(grid_all, obs),
            statn_all = NSE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

kable(ensem_nse_all) %>%
  kable_styling(full_width = F)


```

### Annual NSE for ensembles

```{r annual nse, echo = F}

yr_nse_ensem <- ensem %>%
  ungroup() %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(grid_ensemble = NSE(grid_ensemble, obs),
            statn_ensemble = NSE(statn_ensemble, obs),
            all_ensemble = NSE(all_ensemble, obs),
            grid_all = NSE(grid_all, obs),
            statn_all = NSE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 4)

yr_nse_table <- yr_nse_ensem %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'nse') %>%
  pivot_wider(names_from = 'year', values_from = 'nse')

yr_nse_table %>%
  kable(.) %>%
  kable_styling()

yr_nse_plot <- yr_nse_ensem %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'nse') %>%
  mutate(year = as.factor(year))

#plot annual nse vals for ensembles
plot_nse_yr_ensem <- function(calyear) {
  yr_nse_plot %>%
    filter(year == calyear) %>%
    ggplot(aes(x = model_run,
               y = nse)) +
    geom_col() +
    ggtitle(calyear) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1))
}

name <- levels(yr_nse_plot$year)

lapply(name, plot_nse_yr_ensem)

```

### Monthly NSE for ensembles

```{r monthly rmse, echo =F}

mo_nse <- ensem %>%
  ungroup() %>%
  drop_na() %>% 
  mutate(month = month(date)) %>%
  group_by(month) %>%
  summarize(grid_ensemble = NSE(grid_ensemble, obs),
            statn_ensemble = NSE(statn_ensemble, obs),
            all_ensemble = NSE(all_ensemble, obs),
            grid_all = NSE(grid_all, obs),
            statn_all = NSE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 4)

kable(mo_nse) %>%
  kable_styling(full_width = F)

mo_pivot2 <- mo_nse %>%
  pivot_longer(!month, names_to = 'cal_run', values_to = 'nse') %>%
  drop_na()

nse_plot_mo <- ggplot(mo_pivot2, aes(month, nse, color = cal_run)) + geom_point(size = 3) +
  theme_bw() +
  scale_color_manual(name="cal_run", values=c("grid_ensemble"="maroon", 
                                            "statn_ensemble"="darkturquoise", 
                                            "grid_all"="purple1",
                                            "statn_all"='springgreen4', 
                                            "all_ensemble" = "orange")) 

ggplotly(nse_plot_mo)

```

## Percent bias

Positive values indicate model overestimation and negative values model underestimation. 

### Ensemble pbias for entire period

```{r pbias all, echo = F}

ensem_pbias_all <- ensem %>%
  ungroup() %>%
  summarize(grid_ensemble = pbias(grid_ensemble, obs),
            statn_ensemble = pbias(statn_ensemble, obs),
            all_ensemble = pbias(all_ensemble, obs),
            grid_all = pbias(grid_all, obs),
            statn_all = pbias(statn_all, obs))

kable(ensem_pbias_all) %>%
  kable_styling(full_width = F)


```

### Annual pbias for ensembles

```{r annualpbias, echo = F}

yr_pbias_ensem <- ensem %>%
  ungroup() %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(grid_ensemble = pbias(grid_ensemble, obs),
            statn_ensemble = pbias(statn_ensemble, obs),
            all_ensemble = pbias(all_ensemble, obs),
            grid_all = pbias(grid_all, obs),
            statn_all = pbias(statn_all, obs))

yr_pbias_table <- yr_pbias_ensem %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'pbias') %>%
  pivot_wider(names_from = 'year', values_from = 'pbias')

yr_pbias_table %>%
  kable(.) %>%
  kable_styling()

yr_pbias_plot <- yr_pbias_ensem %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'pbias') %>%
  mutate(year = as.factor(year))

#plot annual pbias vals for ensembles
plot_pbias_yr_ensem <- function(calyear) {
  yr_pbias_plot %>%
    filter(year == calyear) %>%
    ggplot(aes(x = model_run,
               y = pbias)) +
    geom_col() +
    ggtitle(calyear) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1))
}

name <- levels(yr_pbias_plot$year)

lapply(name, plot_pbias_yr_ensem)

```

### Monthly pbias for ensembles

```{r monthly pbias, echo =F}

mo_pbias <- ensem %>%
  ungroup() %>%
  drop_na() %>% 
  mutate(month = month(date)) %>%
  group_by(month) %>%
  summarize(grid_ensemble = pbias(grid_ensemble, obs),
            statn_ensemble = pbias(statn_ensemble, obs),
            all_ensemble = pbias(all_ensemble, obs),
            grid_all = pbias(grid_all, obs),
            statn_all = pbias(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 4)

kable(mo_pbias) %>%
  kable_styling(full_width = F)

mo_pivot2 <- mo_pbias %>%
  pivot_longer(!month, names_to = 'cal_run', values_to = 'pbias') %>%
  drop_na()

pbias_plot_mo <- ggplot(mo_pivot2, aes(month, pbias, color = cal_run)) + 
  geom_point(size = 3) +
  scale_color_manual(name="cal_run", values=c("grid_ensemble"="maroon", 
                                            "statn_ensemble"="darkturquoise", 
                                            "grid_all"="purple1",
                                            "statn_all"='springgreen4', 
                                            "all_ensemble" = "orange")) +
  theme_bw()

ggplotly(pbias_plot_mo)

```

## Cumulative Q

```{r cumq, echo = F}

ensem_cumq <- ensem %>%
  mutate(month = month(date)) %>%
  filter(month %in% c(4:9)) %>%
  select(-month) %>% 
  pivot_longer(!date, names_to = 'cal_run', values_to = 'q_m3s') %>%
  group_by(cal_run, year(date)) %>%
  mutate(cumsum = cumsum(replace_na(q_m3s, 0))) %>%
  rename(year = 4) %>%
  mutate(year = as.factor(year)) %>%
  ungroup()

#plot annual cumulative Q vals for ensembles
plot_cumulq_yr_ensem <- function(calyear) {
  {ensem_cumq %>%
    filter(year == calyear) %>%
    ggplot(aes(x = date,
               y = cumsum,
               color = cal_run)) +
    geom_line() +
    scale_color_manual(name="cal_run", values=c("obs"="black",
                                             "grid_ensemble"="maroon", 
                                            "statn_ensemble"="darkturquoise", 
                                            "grid_all"="purple1",
                                            "statn_all"='springgreen4', 
                                            "all_ensemble" = "orange")) +
    ggtitle(calyear) +
    theme_bw() +
    labs(y = 'cumulative Q (m3s)')} %>%
    ggplotly()
}

name <- levels(ensem_cumq$year)

cumulative_plots <- lapply(name, plot_cumulq_yr_ensem)

htmltools::tagList(cumulative_plots)

cumulative_plots

```

## Percentiles

```{r percentiles, echo = F}


quantile_calc <- function(x, probs, date) {
  tibble(x = quantile(x, probs), probs = probs,
         date = date[x = quantile(x, probs)])
}


percent <- ensem_cumq %>%
  group_by(year, cal_run) %>%
  summarize(quantile_calc(cumsum, c(0.25, 0.5, 0.75), date)) %>%
  mutate(date = as.Date(date)) %>%
  mutate(probs = as.factor(probs))

###
quantile_cal <- function(data, prob) {
  data %>%
    dplyr::group_by(cal_run, year) %>%
    mutate(quantile = paste0(prob),
           value = quantile(cumsum, prob)) %>%
    group_by(cal_run, year, quantile) %>% 
    filter(cumsum >= value) %>%
    filter(date == min(date))
  }

quantiles <- c(0.25, 0.5, 0.75)

quants <- quantiles %>%
  map(~ quantile_cal(data = ensem_cumq, prob = .)) %>%
  bind_rows()
####


#plot percentiles
plot_perc_ensem <- function(perc) {
  {percent %>%
    filter(probs == perc) %>%
    ggplot(aes(x = year,
               y = x,
               color = cal_run)) +
    geom_point(size=3) +
    scale_color_manual(name="cal_run", values=c("obs"="black",
                                             "grid_ensemble"="maroon", 
                                            "statn_ensemble"="darkturquoise", 
                                            "grid_all"="purple1",
                                            "statn_all"='springgreen4', 
                                            "all_ensemble" = "orange")) +
    ggtitle(perc) +
    ylab('Streamflow (cms)') +
    theme_bw()} %>%
    ggplotly()
}

name <- levels(percent$probs)

perc_plots <- lapply(name, plot_perc_ensem)

htmltools::tagList(perc_plots)

perc_plots

```

## Max Q prior to April 1

```{r}

ensem_bould <- left_join(ensem, bouldcr, by = 'date') %>%
  pivot_longer(!c(date, year), names_to = 'source', values_to = 'q_m3s') %>%
  mutate(month = month(date)) %>%
  filter(month %in% 1:3) %>%
  group_by(source, year) %>%
  slice_max(q_m3s, n=1)

early_peakq <- ensem_bould %>%
  mutate(doy = yday(date)) %>%
  select(c(doy, source, q_m3s, year)) %>%
  pivot_wider(names_from = 'source', values_from = c('q_m3s', 'doy'))

ggplot(early_peakq, aes(doy_bouldcr, doy_all_ensemble)) +
  geom_point(size=2.5) +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') +
  theme_bw() +
  ggtitle('DOY of peak Q prior to April 1st - All Ensemble')

ggplot(early_peakq, aes(doy_bouldcr, doy_grid_all)) +
  geom_point(size=2.5) +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') +
  theme_bw() +
  ggtitle('DOY of peak Q prior to April 1st - Grid All')


ggplot(early_peakq, aes(doy_bouldcr, doy_grid_ensemble)) +
  geom_point(size=2.5) +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') +
  theme_bw() +
  ggtitle('DOY of peak Q prior to April 1st - Grid Ensemble')


ggplot(early_peakq, aes(doy_bouldcr, doy_statn_all)) +
  geom_point(size=2.5) +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') +
  theme_bw() +
  ggtitle('DOY of peak Q prior to April 1st - Station All')


ggplot(early_peakq, aes(doy_bouldcr, doy_statn_ensemble)) +
  geom_point(size=2.5) +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') +
  theme_bw() +
  ggtitle('DOY of peak Q prior to April 1st - Station Ensemble')

early_peakq_table <- ensem_bould %>%
  mutate(doy = yday(date)) %>%
  dplyr::arrange(date)

kable(early_peakq_table) %>%
  kable_styling(full_width = F) %>% 
  scroll_box(width = "100%", height = "500px")

```

# Catchment results

## Precip

```{r catch precip, echo = F}
setwd("C:/Users/sears/Documents/Repos/fourmile/catchment_output")

statn <- read_csv('statnall.csv')
grid <- read_csv('gridall.csv')
 
grid <- grid %>% mutate(site = 'grid')
statn <- statn %>% mutate(site = 'statn')

catchment <- bind_rows(grid, statn) %>%
  mutate(year = as.factor(year(time))) %>%
  group_by(year, site) %>%
  mutate(cumulative_p = cumsum(precip))

#plot cumulative precip by year
plot_cumprecip <- function(calyear) {
  {catchment %>%
    filter(year == calyear) %>%
    ggplot(aes(x = time,
               y = cumulative_p, color = site)) +
    geom_line(size=1) +
    ggtitle(calyear) +
    ylab('Cumulative precip (mm)') +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1))} %>%
    ggplotly()
}

name <- levels(catchment$year)

precip_plots <- lapply(name, plot_cumprecip)

htmltools::tagList(precip_plots)

precip_plots

## total P
max_cumulativep <- catchment %>%
  group_by(year, site) %>%
  summarize(total_cumulativep = max(cumulative_p))

ggplot(max_cumulativep, aes(x=year, y=total_cumulativep, color=site)) + 
  geom_point(size=3) +
  ggtitle('Total cumulative precip (mm) by year')

```

## Tmean

```{r tmean catch, echo = F}
## tmean 
tmean <- catchment %>%
  group_by(year, site) %>%
  summarize(tmean = mean(tmean)) %>%
  ggplot(aes(x = year, y=tmean, color = site)) +
  geom_point(size=3) +
  ggtitle('Average temp by year')

tmean


```

# Niwot and HRU7

## SWE and precip

```{r niwot, echo = F}
library(snotelr)

niwot_snotel <- snotel_download(site_id = 663, internal = T)

niwot_snotel <- niwot_snotel %>%
  select(date, snow_water_equivalent, precipitation) %>%
  mutate(date = as.Date(date)) %>%
  rename(swe_mm_snotel = snow_water_equivalent,
         precip_mm_snotel = precipitation) %>%
  #mutate(swe_mm_snotel = swe_mm_snotel*25.4,
         #precip_mm_snotel = precip_mm_snotel*25.4) %>%
  filter(date > '2010-12-31' & date < '2020-10-01')
  
hru7_grid <- read_csv('C:/Users/sears/Documents/Repos/fourmile/HRU_output/HRU_7_grid.csv') %>%
  select(date, precip_mm, swe_mm) %>%
  rename(precip_mm_hrugrid = precip_mm,
         swe_mm_hrugrid = swe_mm)

hru7_statn <- read_csv('C:/Users/sears/Documents/Repos/fourmile/HRU_output/HRU_7_statn.csv') %>%
  select(date, precip_mm, swe_mm) %>%
  rename(precip_mm_hrustatn = precip_mm,
         swe_mm_hrustatn = swe_mm)

niwot <- niwot_snotel %>%
  left_join(hru7_grid, by = 'date') %>%
  left_join(hru7_statn, by = 'date')

# look at swe
niwot_swe <- niwot %>%
  dplyr::select(date, swe_mm_snotel, swe_mm_hrugrid, swe_mm_hrustatn)

kable(niwot_swe) %>%
  kable_styling(full_width = F) %>% 
  scroll_box(width = "100%", height = "500px")

# cumulative swe
niwot_swe2 <- niwot_swe %>%
  mutate(year = year(date)) %>%
  pivot_longer(!c(date,year), names_to = 'source', values_to = 'swe_mm') %>%
  group_by(year, source) %>%
  mutate(swe_cumsum_mm = cumsum(swe_mm))

cum_swe_niwot <- ggplot(niwot_swe2, aes(date, swe_cumsum_mm, color = source)) +
  geom_line() +
  scale_x_date(labels = date_format("%b")) +
  facet_wrap(~year, scales = 'free')

ggplotly(cum_swe_niwot)

#look at precip
niwot_p <- niwot %>%
  dplyr::select(date, precip_mm_snotel, precip_mm_hrugrid, precip_mm_hrustatn)

kable(niwot_p) %>%
  kable_styling(full_width = F) %>% 
  scroll_box(width = "100%", height = "500px")

# cumulative precip
niwot_p2 <- niwot_p %>%
  mutate(year = year(date)) %>%
  pivot_longer(!c(date,year), names_to = 'source', values_to = 'precip_mm') %>%
  group_by(year, source) %>%
  mutate(p_cumsum_mm = cumsum(precip_mm))

cum_precip_niwot <- ggplot(niwot_p2, aes(date, p_cumsum_mm, color = source)) +
  geom_line() +
  scale_x_date(labels = date_format("%b")) +
  facet_wrap(~year, scales = 'free')

ggplotly(cum_precip_niwot)



```

## ET

```{r ET, echo = F}

niwot_et <- read_csv('C:/Users/sears/Documents/Repos/fourmile/HRU_output/Niwot_daily_et.csv') %>%
  filter(year > 2010) %>%
  mutate(date = make_date(year = year, month = month, day = day)) %>%
  select(date, et) %>%
  rename(et_niwot = et)
  

hru7_grid <- read_csv('C:/Users/sears/Documents/Repos/fourmile/HRU_output/HRU_7_grid.csv') %>%
  select(date, AET_mm) %>%
  rename(et_hru7grid = AET_mm)

hru7_statn <- read_csv('C:/Users/sears/Documents/Repos/fourmile/HRU_output/HRU_7_statn.csv') %>%
  select(date, AET_mm) %>%
  rename(et_hru7statn = AET_mm)

niwot_et_compare <- niwot_et %>%
  left_join(hru7_grid, by = 'date') %>%
  left_join(hru7_statn, by = 'date') %>%
  mutate(year = year(date)) %>%
  filter(year < 2021) %>% 
  pivot_longer(!c(date, year), names_to= 'source', values_to = 'et_mm') %>%
  mutate(year = as.factor(year))

#plot ET by year
plot_ET <- function(calyear) {
  {niwot_et_compare %>%
    filter(year == calyear) %>%
    ggplot(aes(x = date,
               y = et_mm, color = source)) +
    geom_line(size=1) +
    ggtitle(calyear) +
    ylab('ET (mm/day)') +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust=1))} %>%
    ggplotly()
}

name <- levels(niwot_et_compare$year)

ET_plots <- lapply(name, plot_ET)

htmltools::tagList(ET_plots)

ET_plots

# 1:1 scatter plots for Niwot vs grid and Niwot vs station
niwot_et_scatter <- niwot_et_compare %>%
  filter(et_mm > 0)

# Niwot vs grid
et_grid_obs <- niwot_et_scatter %>%
  filter(source == c('et_niwot','et_hru7grid')) %>%
  pivot_wider(names_from = 'source', values_from = 'et_mm')

#scatter of grid vs niwot
et_scatter_grid_obs <- ggplot(et_grid_obs, aes(x = et_niwot, y = et_hru7grid)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') + 
  ggtitle('Niwot ET vs. HRU7 grid ET')

et_scatter_grid_obs

# Niwot vs statn inputs
et_statn_obs <- niwot_et_scatter %>%
  filter(source == c('et_niwot','et_hru7statn')) %>%
  pivot_wider(names_from = 'source', values_from = 'et_mm')

#scatter of grid vs niwot
et_scatter_statn_obs <- ggplot(et_statn_obs, aes(x = et_niwot, y = et_hru7statn)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, size=1, color='red') + 
  ggtitle('Niwot ET vs. HRU7 station ET')

et_scatter_statn_obs
                              
```




```{r reach hydrographs, echo = F}

# reach <- read_csv('reach_all.csv') %>%
#   mutate(reach = as.factor(reach)) %>%
#   pivot_longer(!c(date, reach, WY), names_to = 'cal', values_to = 'q_cms')
# 
#   
# plotq_reach <- function(reach_name) {
#   {reach %>%
#     filter(reach == reach_name) %>%
#     ggplot(aes(x = date,
#                y = q_cms,
#                color = cal)) + 
#     geom_line() + 
#     ggtitle(reach_name) +
#     theme_bw()} %>%
#     ggplotly()
#   
# }
# 
# name <- levels(reach$reach)
# 
# try2 <- lapply(name, plotq_reach)
# 
# htmltools::tagList(try2)
# 
# ```
# 
# ### Overall KGE by reach
# 
# ```{r reach kge, echo = F}
# 
# reach_pivot <- reach %>%
#   pivot_wider(names_from = 'cal', values_from = 'q_cms') %>%
#   mutate(WY = as.factor(calcWaterYear(date)))
# 
# reach_kge_all <- reach_pivot %>%
#   group_by(reach) %>%
#   summarize(grid2011 = KGE(grid_2011, obs),
#             grid2012 = KGE(grid_2012, obs),
#             grid2013 = KGE(grid_2013, obs),
#             grid2014 = KGE(grid_2014, obs),
#             grid2015 = KGE(grid_2015, obs),
#             grid2016 = KGE(grid_2016, obs),
#             grid2017 = KGE(grid_2017, obs),
#             grid2018 = KGE(grid_2018, obs),
#             grid2019 = KGE(grid_2019, obs),
#             grid2020 = KGE(grid_2020, obs),
#             gridall = KGE(grid_all, obs),
#             statn2011 = KGE(statn_2011, obs),
#             statn2012 = KGE(statn_2012, obs),
#             statn2013 = KGE(statn_2013, obs),
#             statn2014 = KGE(statn_2014, obs),
#             statn2015 = KGE(statn_2015, obs),
#             statn2016 = KGE(statn_2016, obs),
#             statn2017 = KGE(statn_2017, obs),
#             statn2018 = KGE(statn_2018, obs),
#             statn2019 = KGE(statn_2019, obs),
#             statn2020 = KGE(statn_2020, obs),
#             statnall = KGE(statn_all, obs)) %>%
#     mutate_if(is.numeric,
#             round,
#             digits = 2)
# 
# 
# reach_kge_all <- reach_kge_all %>%
#   pivot_longer(!reach, names_to = 'cal_runs', values_to = 'KGE') %>%
#   pivot_wider(names_from = 'reach', values_from = 'KGE')
# 
# 
# kable(reach_kge_all) %>%
#   kable_styling(full_width = F)
# 
# 
# obs_count <- reach_pivot %>%
#   select(obs, reach) %>%
#   drop_na() %>%
#   group_by(reach) %>%
#   summarize(count_obs = n())
# 
# kable(obs_count, caption = 'Streamflow observation count') %>%
#   kable_styling(full_width = F)


```
