---
title: "Fourmile Calibrations and Output"
author: "Megan Sears"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: journal
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  message = F, 
  warning  = F)

library(tidyverse)
library(plotly)
library(lubridate)
library(knitr)
library(kableExtra)
library(dataRetrieval)
library(hydroGOF)
library(sp)
library(raster)
library(sf)
library(mapview)
library(here)
library(scales)
library(dataRetrieval)
library(tmap)
library(ggpubr)
library(gridExtra)
library(stringr)
library(cowplot)

```

```{r load in files, include = F}

setwd('/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates')

#kge <- read_csv('calruns_KGE.csv') # skip for now - come back if needed

```

# Parameters

## Scatter plots

```{r read in params, echo = FALSE, message = FALSE, warning = FALSE, include = F}

setwd("/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates/cals")

#pull in all filenames with composite
filenames <- list.files('.', pattern=".csv", full.names=F)

#read all the csvs
dataframes <- lapply(filenames, read_csv)

#name all the csv
names(dataframes) <- substr(filenames, 1, 10)

#extract csvs from list to global env
lapply(names(dataframes), function(x) assign(x, dataframes[[x]], envir = .GlobalEnv))
rm(dataframes) #remove dataframes list

```


```{r params, echo = FALSE, message = FALSE, warning = FALSE}

# function to read files, remove top rows, paste site name
read_cals <- function(df, name){
    df <- df %>%
      slice(-c(1:9, 146:277)) %>%
      separate(Parameter, c("Parameter", "value"), sep = ",") %>%
      drop_na() %>%
      dplyr::select(-1) %>% 
      mutate(cal = name)
    

}

grid_2011 <- read_cals(grid_2011., name = 'grid_2011')
grid_2012 <- read_cals(grid_2012., name = 'grid_2012')
grid_2013 <- read_cals(grid_2013., name = 'grid_2013')
grid_2014 <- read_cals(grid_2014., name = 'grid_2014')
grid_2015 <- read_cals(grid_2015., name = 'grid_2015')
grid_2016 <- read_cals(grid_2016., name = 'grid_2016')
grid_2017 <- read_cals(grid_2017., name = 'grid_2017')
grid_2018 <- read_cals(grid_2018., name = 'grid_2018')
grid_2019 <- read_cals(grid_2019., name = 'grid_2019')
grid_2020 <- read_cals(grid_2020., name = 'grid_2020')
grid_all <- read_cals(grid_all.c, name = 'grid_all')

grid <- bind_rows(grid_2011, grid_2012, grid_2013, grid_2014, grid_2015,
                  grid_2016, grid_2017, grid_2018, grid_2019, grid_2020,
                  grid_all) %>%
  mutate(input_data = 'grid') %>%
  mutate(year_missing_almost = gsub('grid_', '', cal)) %>%
  mutate(year_missing = gsub('all', 'none', year_missing_almost)) %>%
  dplyr::select(-c(year_missing_almost)) %>%
  rename(param = Parameter) %>%
  filter(!param == 'locGrw',
         !param == 'tempRes')

statn_2011 <- read_cals(statn_2011, name = 'statn_2011')
statn_2012 <- read_cals(statn_2012, name = 'statn_2012')
statn_2013 <- read_cals(statn_2013, name = 'statn_2013')
statn_2014 <- read_cals(statn_2014, name = 'statn_2014')
statn_2015 <- read_cals(statn_2015, name = 'statn_2015')
statn_2016 <- read_cals(statn_2016, name = 'statn_2016')
statn_2017 <- read_cals(statn_2017, name = 'statn_2017')
statn_2018 <- read_cals(statn_2018, name = 'statn_2018')
statn_2019 <- read_cals(statn_2019, name = 'statn_2019')
statn_2020 <- read_cals(statn_2020, name = 'statn_2020')
statn_all <- read_cals(statn_all., name = 'statn_all')

statn <- bind_rows(statn_2011, statn_2012, statn_2013, statn_2014, statn_2015,
                  statn_2016, statn_2017, statn_2018, statn_2019, statn_2020,
                  statn_all) %>%
  mutate(input_data = 'statn') %>%
  mutate(year_missing_almost = gsub('statn_', '', cal)) %>%
  mutate(year_missing = gsub('all', 'none', year_missing_almost)) %>%
  dplyr::select(-c(year_missing_almost)) %>%
  rename(param = Parameter) %>%
  filter(!param == 'locGrw',
         !param == 'tempRes')

params <- bind_rows(statn, grid)

params <- params %>%
  filter(!param %in% c('angstrom_a', 'angstrom_b', 
                      'Beta_min', 
                      'Beta_rsd', "Beta_trans", 'clat', 
                      'delayNitrification',
                      'denitrificationRateCoefficient', 
                      'denitrificationSoilSaturationThreshold',
                      'deposition_factor', 'drrad', 
                      'drspac', 'initLPS', 'initRG1',
                      'initRG2', 'Ksink', 'LExCoef', 
                      'longTZ', 'N_concRG1', 'N_concRG2', 'N_delay_RG1',
                      'N_delay_RG2', 
                      'nitrificationSoilTemperatureThreshold', 
                      'nitrificationSurfaceTemperatureThreshold',
                      'opti', 'piadin', 'rootfactor', 'sceno', 
                      'soilImpGT80', 'soilImpLT80',
                      'soilLinRed', 'soilMaxPerc', 'temp_lag')) %>%
    mutate(value = as.numeric(value),
         param = as.factor(param))

write_csv(params, '/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates/params_unburn.csv')

#function to plot all params
plot_params <- function(param_name) {
  params %>%
    filter(param == param_name) %>%
    ggplot(aes(x = year_missing,
               y = value,
               shape = input_data, 
               color = input_data)) + 
    geom_point(size = 3) + 
    ggtitle(param_name) +
    theme_bw()
}

name <- levels(params$param)

lapply(name, plot_params)

#write.csv(params, 'params.csv')

# find min and max of grid and statn param for sensitivity analysis
# grid_minmax <- grid %>%
#   group_by(param) %>%
#   summarize(min = as.numeric(min(value)),
#             max = as.numeric(max(value))) %>%
#   mutate(input = 'grid_unburn')
# 
# statn_minmax <- statn %>%
#   group_by(param) %>%
#   summarize(min = as.numeric(min(value)),
#             max = as.numeric(max(value))) %>%
#   mutate(input = 'statn_unburn')
# 
# minmax_burn <- burn_params %>%
#   group_by(params, input_data) %>%
#   summarize(min = min(value),
#             max = max(value)) %>%
#   mutate(input = paste(input_data, '_burn')) %>%
#   dplyr::select(-input_data) %>%
#   rename(param = params) %>%
#   mutate(param = as.character(param))
# 
# minmax_params <- bind_rows(grid_minmax, statn_minmax, minmax_burn)
# write.csv(minmax_params, 'min_max_params.csv')

```



```{r density plots, echo = FALSE, message = FALSE, warning = FALSE}

mean_params <- params %>%
  group_by(param, input_data) %>%
  summarize(mean = mean(value))

plotdens_params <- function(param_name) {
  params %>%
    filter(param == param_name) %>%
    ggplot(aes(x = value,
               fill = input_data,
               color = input_data)) +
    geom_density(alpha=0.5) +
    geom_vline(data=filter(mean_params, param == param_name),
               aes(xintercept=mean, color=input_data),
             linetype="dashed", linewidth=0.75) +
    ggtitle(param_name) +
    theme_bw()
}

name <- levels(params$param)

lapply(name, plotdens_params)

```

## Burn parameters

```{r echo = FALSE, message = FALSE, warning = FALSE, include = F}

rm(statn_2011, statn_2012, statn_2013, statn_2014, statn_2015,
                  statn_2016, statn_2017, statn_2018, statn_2019, statn_2020,
                  statn_all., statn_all)

setwd("/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates/cals")

#pull in all filenames with composite
filenames <- list.files('.', pattern=".csv", full.names=F)

#read all the csvs
dataframes <- lapply(filenames, read_csv)

#name all the csv
names(dataframes) <- substr(filenames, 1, 10)

#extract csvs from list to global env
lapply(names(dataframes), function(x) assign(x, dataframes[[x]], envir = .GlobalEnv))
rm(dataframes) #remove dataframes list

```

```{r echo = FALSE, message = FALSE, warning = FALSE}

# read in all the grid burn params
read_cals_burn <- function(df, name){
    df <- df %>%
      slice(-c(1:274)) %>%
      separate_wider_delim(Parameter, 
                       delim = ',',
                       names = c('soilID',
                                 'luca_a_rain',
                                 'luca_a_snow',
                                 'luca_soilMaxInfSummer',
                                 'luca_soilMaxDPS',
                                 'luca_lagSurfaceRunoff',
                                 'luca_soilDistMPSLPS')) %>%
      slice(-1) %>%
      dplyr::select(-1) %>% 
      mutate(cal = name)
}

grid_2011_burn <- read_cals_burn(grid_2011., name = 'grid_2011')
grid_2012_burn <- read_cals_burn(grid_2012., name = 'grid_2012')
grid_2013_burn <- read_cals_burn(grid_2013., name = 'grid_2013')
grid_2014_burn <- read_cals_burn(grid_2014., name = 'grid_2014')
grid_2015_burn <- read_cals_burn(grid_2015., name = 'grid_2015')
grid_2016_burn <- read_cals_burn(grid_2016., name = 'grid_2016')
grid_2017_burn <- read_cals_burn(grid_2017., name = 'grid_2017')
grid_2018_burn <- read_cals_burn(grid_2018., name = 'grid_2018')
grid_2019_burn <- read_cals_burn(grid_2019., name = 'grid_2019')
grid_2020_burn <- read_cals_burn(grid_2020., name = 'grid_2020')
grid_all_burn <- read_cals_burn(grid_all.c, name = 'grid_all')

grid_burn <- bind_rows(grid_2011_burn,
                  grid_2012_burn,
                  grid_2013_burn,
                  grid_2014_burn,
                  grid_2015_burn,
                  grid_2016_burn,
                  grid_2017_burn,
                  grid_2018_burn,
                  grid_2019_burn,
                  grid_2020_burn,
                  grid_all_burn) %>%
  mutate(input_data = 'grid') %>%
  mutate(year_missing_almost = gsub('grid_', '', cal)) %>%
  mutate(year_missing = gsub('all', 'none', year_missing_almost)) %>%
  dplyr::select(-c(year_missing_almost))

# now do statn burn params
statn_2011_burn <- read_cals_burn(statn_2011, name = 'statn_2011')
statn_2012_burn <- read_cals_burn(statn_2012, name = 'statn_2012')
statn_2013_burn <- read_cals_burn(statn_2013, name = 'statn_2013')
statn_2014_burn <- read_cals_burn(statn_2014, name = 'statn_2014')
statn_2015_burn <- read_cals_burn(statn_2015, name = 'statn_2015')
statn_2016_burn <- read_cals_burn(statn_2016, name = 'statn_2016')
statn_2017_burn <- read_cals_burn(statn_2017, name = 'statn_2017')
statn_2018_burn <- read_cals_burn(statn_2018, name = 'statn_2018')
statn_2019_burn <- read_cals_burn(statn_2019, name = 'statn_2019')
statn_2020_burn <- read_cals_burn(statn_2020, name = 'statn_2020')
statn_all_burn <- read_cals_burn(statn_all., name = 'statn_all')

statn_burn <- bind_rows(statn_2011_burn,
                  statn_2012_burn,
                  statn_2013_burn,
                  statn_2014_burn,
                  statn_2015_burn,
                  statn_2016_burn,
                  statn_2017_burn,
                  statn_2018_burn,
                  statn_2019_burn,
                  statn_2020_burn,
                  statn_all_burn) %>%
  mutate(input_data = 'statn') %>%
  mutate(year_missing_almost = gsub('statn_', '', cal)) %>%
  mutate(year_missing = gsub('all', 'none', year_missing_almost)) %>%
  dplyr::select(-c(year_missing_almost))

burn_params <- bind_rows(grid_burn, statn_burn) %>%
  ungroup() %>%
  mutate(across(c(luca_a_rain:luca_soilDistMPSLPS), as.numeric)) %>%
  group_by(cal) %>%
  mutate(across(c(luca_a_rain:luca_soilDistMPSLPS), mean)) %>%
  filter(soilID == 22) %>%
  dplyr::select(-soilID) %>% 
  pivot_longer(!c(cal, input_data, year_missing), 
               names_to = 'params',
               values_to = 'value') %>% 
  mutate(params = str_remove(params, 'luca_')) %>%
  mutate(params = as.factor(params),
         burn = 'yes') 
  

```

```{r echo = FALSE, message = FALSE, warning = FALSE}

plot_burnparams <- function(param_name) {
  burn_params %>%
    filter(params == param_name) %>%
    ggplot(aes(y = value,
               x = year_missing,
               color = input_data)) +
    geom_point(size = 3) +
    ggtitle(param_name) +
    theme_bw()
}

name2 <- levels(burn_params$params)

lapply(name2, plot_burnparams)

```

## Combined parameters

The burned HRU parameters were averaged together.

```{r echo = FALSE, message = FALSE, warning = FALSE}

params2 <- params %>%
  mutate(burn = 'no') %>%
  filter(param %in% c('a_rain',
                        'a_snow',
                        'soilMaxInfSummer',
                        'soilMaxDPS',
                        'lagSurfaceRunoff',
                        'soilDistMPSLPS'))

params_combo <- bind_rows(params2,
                          burn_params %>%
                            rename(param = params))

#function to plot all params
plot_params <- function(param_name) {
  params_combo %>%
    filter(param == param_name) %>%
    ggplot(aes(x = year_missing,
               y = value,
               shape = burn, 
               color = input_data)) + 
    geom_point(size = 3) + 
    ggtitle(param_name) +
    theme_bw()
}

#name <- levels(params_combo$param)

lapply(name2, plot_params)


# boxplots of burned and unburned

ggplot(params_combo, aes(x=burn, y=value, fill=input_data)) +
  geom_boxplot() +
  facet_wrap(~param, scales = 'free_y')
# 
#write_csv(params_combo, '/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates/params_burn_unburn.csv')

```

## Parameters area weighted

```{r echo = FALSE, message = FALSE, warning = FALSE}

# add area weights to params combo
params_weighted <- params_combo %>%
  mutate(area = if_else(burn == 'no', 48243400,
                        18823000)) %>%
  group_by(param, cal) %>%
  summarize(numerator = sum(value * area),
    denominator = sum(area)) %>%
  mutate(area_weighted_average = numerator / denominator) %>%
  dplyr::select(-c(numerator, denominator)) %>%
  separate(col = cal, into = c("source", "year_missing"), sep = "_")
  
#write_csv(params_weighted, '/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates/params_weighted_dec2024.csv')

#function to plot all params
plot_params <- function(param_name) {
  params_weighted %>%
    filter(param == param_name) %>%
    ggplot(aes(x = year_missing,
               y = area_weighted_average,
               color = source)) + 
    geom_point(size = 3) + 
    ggtitle(param_name) +
    theme_bw()
}

#name <- levels(params_combo$param)

lapply(name2, plot_params)

```

# Outlet results

## Hydrograph

```{r hydrographs, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10, fig.height=6}

setwd('/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates')

flow <- read_csv('discharge_all.csv') %>%
  replace(.==-9999, NA) %>%
  rename(date = time) %>%
  mutate(date = mdy(date))


flow_pivot <- flow %>%
  pivot_longer(!date, names_to = 'cal_run', values_to = 'q_m3s') %>%
  mutate(year = as.factor(year(date)))


q <- ggplot(flow_pivot, aes(date, q_m3s, color = cal_run)) +
  geom_line() +
  scale_color_manual(name="cal_run", values=c('obs' = 'black',
                                            "grid_2011"="seagreen",
                                            "grid_2012"="seagreen2",
                                            "grid_2013"="steelblue",
                                            "grid_2014"='dodgerblue',
                                            "grid_2015" = "cyan3",
                                            'grid_2016' = 'blue',
                                            'grid_2017' = 'blue4',
                                            'grid_2018' = 'cadetblue',
                                            'grid_2019' = 'lightgreen',
                                            'grid_2020' = 'olivedrab',
                                            'grid_all' = 'steelblue3',
                                            "statn_2011"="maroon",
                                            "statn_2012"="deeppink4",
                                            "statn_2013"="deeppink",
                                            "statn_2014"='purple',
                                            "statn_2015" = "mediumorchid1",
                                            'statn_2016' = 'indianred',
                                            'statn_2017' = 'sienna',
                                            'statn_2018' = 'salmon2',
                                            'statn_2019' = 'mediumpurple1',
                                            'statn_2020' = 'violetred',
                                            'statn_all' = 'red')) +
  theme_bw(base_size=20)

ggplotly(q)

```

# Q 1:1  and residual plots

```{r}

flowComp <- flow %>%
  dplyr::select(date,obs, statn_all, grid_all) %>%
  drop_na(obs) %>% 
  mutate(month = month(date)) %>%
  mutate(statn_res = obs - statn_all,
         grid_res = obs - grid_all)

statn_comp <- ggplot(flowComp) +
  geom_point(aes(x=obs, y = statn_all, color=as.factor(month))) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red")

ggplotly(statn_comp)

grid_comp <- ggplot(flowComp) +
  geom_point(aes(x=obs, y = grid_all, color = as.factor(month))) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  ylim(0,5)

ggplotly(grid_comp)


statn_res <- ggplot(flowComp) + geom_point(aes(x=obs, y = statn_res, color = as.factor(month))) +
  theme_bw(base_size = 20) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red")+
  ylim(-5, 6)

ggplotly(statn_res)

ggplot(flowComp) + geom_point(aes(x=obs, y = grid_res, color = as.factor(month))) +
  theme_bw(base_size = 20)+
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") 

grid_res <- ggplot(flowComp) + geom_point(aes(x=obs, y = grid_res, color = as.factor(month))) +
  theme_bw(base_size = 20) + ylim(-5,6)+
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") 

ggplotly(grid_res)

################################################################################

# make the actual figures
compFlip <- flowComp %>%
  dplyr::select(-month) %>%
  pivot_longer(!c(date, obs), names_to = 'flow_type',
               values_to = 'flow_cms')

# residual scatter plot
plot <- compFlip %>%
  filter(flow_type %in% c('statn_res', 'grid_res')) %>%
  ggplot(., aes(x=obs, 
                     y=flow_cms,
                color = flow_type)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point(size=3,
             alpha=0.6) +
  ylim(-5,6) +
  theme_bw(base_size = 20) +
  scale_color_manual(values = c("#0047AB", "orange")) +
  labs(x='Observed discharge (cms)',
       y='Residuals (cms)') +
  facet_wrap(~flow_type,
             labeller = as_labeller(c("grid_res" = "Gridded", "statn_res" = "Station"))) +
  theme(
    legend.position = 'none',
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black")
  )

plot

# pick select years to show resids over time
plot_bottom12 <- compFlip %>%
  filter(flow_type %in% c('statn_res', 'grid_res')) %>%
  mutate(year = year(date)) %>%
  filter(year %in% c(2016)) %>% 
  mutate(flow_type = if_else(flow_type == 'grid_res', 
                             "Gridded",
                             "Station")) %>%
  ggplot(aes(x = date, y = flow_cms, color = flow_type)) +  
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = c("#0047AB", "orange")) +
  scale_x_date(date_labels = "%b %Y", 
               date_breaks = "1 month") +
  labs(x = element_blank(),
       y = 'Residuals (cms)') +
  theme_bw(base_size = 20) +
  theme(
    legend.position = c(0.93, 0.85),
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white")
  )

plot_bottom12

# add 2 above plots together
plot_grid(plot, plot_bottom12, ncol = 1)

# export
ggsave('/Users/megansears/Documents/Repos/fourmile/figures/resids.png',
       dpi=600,
       width = 12,
       height = 8)

# OPTION 2 - make the bottom the whole time series
plot_bottom <- compFlip %>%
  filter(flow_type %in% c('statn_res', 'grid_res')) %>%
  complete(date = seq.Date(min(date), max(date), by = "day"), fill = list(flow_cms = NA)) %>%
  # Create a new group ID that resets at each missing value (only where flow_cms is NA)
  mutate(group_id = cumsum(is.na(flow_cms))) %>%
  filter(!is.na(flow_cms)) %>%
  mutate(flow_type = if_else(flow_type == 'grid_res', 
                             "Gridded",
                             "Station")) %>%
  ggplot(aes(x = date, y = flow_cms, color = flow_type, group = group_id)) +  
  geom_line(size=1, alpha=0.7) +  
  ylim(-4,6) +
  scale_color_manual(values = c("#0047AB", "orange")) +
  labs(x=element_blank(),
       y='Residuals (cms)') +
  theme(
    legend.position = c(0.9, 0.87),
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black")
  )
  
plot_bottom

plot_grid(plot, plot_bottom, ncol = 1)

# export
ggsave('/Users/megansears/Documents/Repos/fourmile/figures/resids_option2.png',
       dpi=600,
       width = 12,
       height = 8)

```

## add flow 2016 to fig

```{r}

flow <- read_csv('./discharge_all.csv') %>%
  replace(.==-9999, NA) %>%
  rename(date = time) %>%
  mutate(date = mdy(date)) %>%
  drop_na()

flow_pivot <- flow %>%
  pivot_longer(!date, names_to = 'cal_run', values_to = 'q_m3s') %>%
  mutate(year = as.factor(year(date))) %>%
  filter(cal_run %in% c('grid_all',
                        'statn_all',
                        'obs')) %>%
  mutate(cal_run = case_match(cal_run,
                            'grid_all' ~ 'Gridded',
                            'statn_all' ~ 'Station',
                            'obs' ~ 'Observed'))

flowEg <- flow_pivot %>%
  filter(year %in% c(2016)) %>%
  ggplot(aes(x = date,
             y = q_m3s, 
             color = cal_run,
             linetype = cal_run)) + 
  geom_line(size = 1, alpha = 1) + 
  theme_bw(base_size = 20) +
  scale_color_manual(values = c("Gridded" = "#0047AB", 
                                "Observed" = "black", 
                                "Station" = "orange")) +
  scale_linetype_manual(values = c("Gridded" = "solid",
                                   "Observed" = "dashed", 
                                   "Station" = "solid")) +
  labs(x = element_blank(),
       y = "Streamflow (cms)") +
   scale_x_date(date_labels = "%b",
               date_breaks = "1 month") +
  theme(
    legend.position = c(0.9, 0.9),
    legend.text = element_text(size = 16),
    legend.key.width = unit(2, "lines"),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black")
  )

flowEg

ggsave('/Users/megansears/Documents/Repos/fourmile/figures/2016_flowEg.png',
       dpi=600,
       width = 12,
       height = 8)

plot_grid(plot, flowEg, plot_bottom12, ncol = 1)

```

## Cumulative volume

```{r cumq, echo = FALSE, message = FALSE, warning = FALSE}

flow_cumq <- flow_pivot %>%
  mutate(month = month(date)) %>%
  filter(month %in% c(4:9)) %>%
  dplyr::select(-month) %>%
  #pivot_longer(!date, names_to = 'cal_run', values_to = 'q_m3s') %>%
  mutate(vol_m3 = q_m3s * 86400) %>%
  group_by(cal_run, year(date)) %>%
  mutate(cumsum = cumsum(replace_na(vol_m3, 0))) %>%
  #rename(year = 4) %>%
  mutate(year = as.factor(year)) %>%
  ungroup()

#plot annual cumulative Q vals for ensembles
plot_cumulq_yr_ <- function(calyear) {
  {flow_cumq %>%
    filter(year == calyear) %>%
    ggplot(aes(x = date,
               y = cumsum,
               color = cal_run)) +
    geom_line() +
scale_color_manual(name="cal_run", values=c('obs' = 'black',
                                            "grid_2011"="seagreen",
                                            "grid_2012"="seagreen2",
                                            "grid_2013"="steelblue",
                                            "grid_2014"='dodgerblue',
                                            "grid_2015" = "cyan3",
                                            'grid_2016' = 'blue',
                                            'grid_2017' = 'blue4',
                                            'grid_2018' = 'cadetblue',
                                            'grid_2019' = 'lightgreen',
                                            'grid_2020' = 'olivedrab',
                                            'grid_all' = 'steelblue3',
                                            "statn_2011"="maroon",
                                            "statn_2012"="deeppink4",
                                            "statn_2013"="deeppink",
                                            "statn_2014"='purple',
                                            "statn_2015" = "mediumorchid1",
                                            'statn_2016' = 'indianred',
                                            'statn_2017' = 'sienna',
                                            'statn_2018' = 'salmon2',
                                            'statn_2019' = 'mediumpurple1',
                                            'statn_2020' = 'violetred',
                                            'statn_all' = 'red')) +
    ggtitle(calyear) +
    theme_bw() +
    labs(y = 'Volume (m^3)')} %>%
    ggplotly()
}

name <- levels(flow_cumq$year)

cumulative_plots <- lapply(name, plot_cumulq_yr_)

htmltools::tagList(cumulative_plots)

cumulative_plots

```

## NSE 

```{r}

flow_nse_all <- flow %>%
  drop_na() %>%
  summarize(grid2011 = NSE(grid_2011, obs),
            grid2012 = NSE(grid_2012, obs),
            grid2013 = NSE(grid_2013, obs),
            grid2014 = NSE(grid_2014, obs),
            grid2015 = NSE(grid_2015, obs),
            grid2016 = NSE(grid_2016, obs),
            grid2017 = NSE(grid_2017, obs),
            grid2018 = NSE(grid_2018, obs),
            grid2019 = NSE(grid_2019, obs),
            grid2020 = NSE(grid_2020, obs),
            gridall = NSE(grid_all, obs),
            statn2011 = NSE(statn_2011, obs),
            statn2012 = NSE(statn_2012, obs),
            statn2013 = NSE(statn_2013, obs),
            statn2014 = NSE(statn_2014, obs),
            statn2015 = NSE(statn_2015, obs),
            statn2016 = NSE(statn_2016, obs),
            statn2017 = NSE(statn_2017, obs),
            statn2018 = NSE(statn_2018, obs),
            statn2019 = NSE(statn_2019, obs),
            statn2020 = NSE(statn_2020, obs),
            statnall = NSE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

flow_nse_all <- flow_nse_all %>%
  pivot_longer(everything()) %>%
  arrange(value)

# determine nse for each year for every model run
flow_year <- flow %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(
    grid2011 = NSE(grid_2011, obs),
            grid2012 = NSE(grid_2012, obs),
            grid2013 = NSE(grid_2013, obs),
            grid2014 = NSE(grid_2014, obs),
            grid2015 = NSE(grid_2015, obs),
            grid2016 = NSE(grid_2016, obs),
            grid2017 = NSE(grid_2017, obs),
            grid2018 = NSE(grid_2018, obs),
            grid2019 = NSE(grid_2019, obs),
            grid2020 = NSE(grid_2020, obs),
            gridall = NSE(grid_all, obs, na.rm = T, method='2012'),
            statn2011 = NSE(statn_2011, obs),
            statn2012 = NSE(statn_2012, obs),
            statn2013 = NSE(statn_2013, obs),
            statn2014 = NSE(statn_2014, obs),
            statn2015 = NSE(statn_2015, obs),
            statn2016 = NSE(statn_2016, obs),
            statn2017 = NSE(statn_2017, obs),
            statn2018 = NSE(statn_2018, obs),
            statn2019 = NSE(statn_2019, obs),
            statn2020 = NSE(statn_2020, obs),
            statnall = NSE(statn_all, obs, na.rm=T, method='2012')) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

flow_nse <- flow_year %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'nse') %>%
  pivot_wider(names_from = 'year', values_from = 'nse')

flow_plot <- flow_year %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'nse') %>%
  mutate(year = as.factor(year))

# add all to the plot below
nse_all <- flow_nse_all %>%
  mutate(year = 'All') %>%
  rename(model_run = name,
         nse = value)

flow_plot_updated <- bind_rows(flow_plot, nse_all)

# nse figure
flow_plot_updated <- flow_plot_updated %>% 
  mutate(source = case_when(
    grepl("grid", model_run) ~ "grid",
    grepl("statn", model_run) ~ "statn"),
    year_excluded = str_extract(model_run, "\\d{4}$")) %>%
  mutate(year_excluded = if_else(model_run %in% c('gridall',
                                                       'statnall'),
                                  'None', year_excluded))

# put nse into categories
nseCats <- flow_plot_updated %>%
  mutate(nseCat = case_when(
    nse > 0.75 ~ 'Very good',
    nse > 0.65 & nse <= 0.75 ~ 'Good',
    nse > 0.5 & nse <= 0.65 ~ 'Satisfactory',
    nse <= 0.5  ~ 'Unsatisfactory'),
    nseCat = factor(nseCat, levels = c("Unsatisfactory", 
                                           "Satisfactory", 
                                           "Good", 
                                           "Very good")))

write_csv(nseCats, '/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates/nseCats.csv')

# facet wrap the plots
new_facet_titles <- c(
  "grid" = "Gridded",
  "statn" = "Station"
)

both_nse_plot <- nseCats %>%
  ggplot(aes(x = year, 
             y = year_excluded, 
             fill = nseCat)) +
  geom_tile(color = "white") +
  facet_wrap(~source, labeller = labeller(source = new_facet_titles)) +
  scale_fill_manual(values = c(
    "Unsatisfactory" = "#F1F4EEFF", 
    "Satisfactory" = "#EFDDCFFF",
    "Good" = "#72E1E1FF",
    "Very good" = "#009474FF"
  )) +
  geom_text(aes(label = sprintf("%.2f", nse)), 
            color = "black", 
            size = 2.75) +
  theme_bw(base_size=18) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = 'bottom',
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.key.width = unit(1, "cm"),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    legend.margin = margin(t = -8, b = -4, unit = "pt")
  ) +
  labs(y = "Year excluded",
       x = 'Year',
       fill = 'NSE')

both_nse_plot

ggsave('/Users/megansears/Documents/Repos/fourmile/figures/nse_heatmap_both_cats.png',
       dpi=600,
       width = 10,
       height = 6)



```


## KGE

### Overall KGE

```{r kge overall, echo = FALSE, message = FALSE, warning = FALSE}

flow_kge_all <- flow %>%
  summarize(grid2011 = KGE(grid_2011, obs),
            grid2012 = KGE(grid_2012, obs),
            grid2013 = KGE(grid_2013, obs),
            grid2014 = KGE(grid_2014, obs),
            grid2015 = KGE(grid_2015, obs),
            grid2016 = KGE(grid_2016, obs),
            grid2017 = KGE(grid_2017, obs),
            grid2018 = KGE(grid_2018, obs),
            grid2019 = KGE(grid_2019, obs),
            grid2020 = KGE(grid_2020, obs),
            gridall = KGE(grid_all, obs),
            statn2011 = KGE(statn_2011, obs),
            statn2012 = KGE(statn_2012, obs),
            statn2013 = KGE(statn_2013, obs),
            statn2014 = KGE(statn_2014, obs),
            statn2015 = KGE(statn_2015, obs),
            statn2016 = KGE(statn_2016, obs),
            statn2017 = KGE(statn_2017, obs),
            statn2018 = KGE(statn_2018, obs),
            statn2019 = KGE(statn_2019, obs),
            statn2020 = KGE(statn_2020, obs),
            statnall = KGE(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)


flow_kge_all <- flow_kge_all %>%
  pivot_longer(everything()) %>%
  arrange(value)

kable(flow_kge_all) %>%
  kable_styling(full_width = F)

```

### KGE by year

```{r kge by year, echo = FALSE, message = FALSE, warning = FALSE}

flow_year <- flow %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(
    grid2011 = KGE(grid_2011, obs),
            grid2012 = KGE(grid_2012, obs),
            grid2013 = KGE(grid_2013, obs),
            grid2014 = KGE(grid_2014, obs),
            grid2015 = KGE(grid_2015, obs),
            grid2016 = KGE(grid_2016, obs),
            grid2017 = KGE(grid_2017, obs),
            grid2018 = KGE(grid_2018, obs),
            grid2019 = KGE(grid_2019, obs),
            grid2020 = KGE(grid_2020, obs),
            gridall = KGE(grid_all, obs, na.rm = T, method='2012'),
            statn2011 = KGE(statn_2011, obs),
            statn2012 = KGE(statn_2012, obs),
            statn2013 = KGE(statn_2013, obs),
            statn2014 = KGE(statn_2014, obs),
            statn2015 = KGE(statn_2015, obs),
            statn2016 = KGE(statn_2016, obs),
            statn2017 = KGE(statn_2017, obs),
            statn2018 = KGE(statn_2018, obs),
            statn2019 = KGE(statn_2019, obs),
            statn2020 = KGE(statn_2020, obs),
            statnall = KGE(statn_all, obs, na.rm=T, method='2012')) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

flow_kge <- flow_year %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'kge') %>%
  pivot_wider(names_from = 'year', values_from = 'kge')

flow_kge %>%
  kable(.) %>%
  kable_styling()


flow_plot <- flow_year %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'kge') %>%
  mutate(year = as.factor(year))

# add all to the plot below
kge_all <- flow_kge_all %>%
  mutate(year = 'All') %>%
  rename(model_run = name,
         kge = value)

flow_plot_updated <- bind_rows(flow_plot, kge_all)

# flow_plot_updated <- flow_plot_updated %>%
#   mutate(kge_revise = if_else(kge < 0, 0, kge))

flow_plot_updated <- flow_plot_updated %>% 
  mutate(source = case_when(
    grepl("grid", model_run) ~ "grid",
    grepl("statn", model_run) ~ "statn"),
    year_excluded = str_extract(model_run, "\\d{4}$")) %>%
  mutate(year_excluded = if_else(model_run %in% c('gridall',
                                                       'statnall'),
                                  'None', year_excluded))


# # need to make separate plots bc can't put boxplots in margins for facet wrap
# grid_kge_plot <- flow_plot_updated %>%
#   filter(source == 'grid') %>% 
# ggplot(., aes(x = year_excluded, 
#               y = year, fill = 
#                 kge_revise)) +
#   geom_tile(color = "white") +
#   scale_fill_viridis_c(option = "mako", 
#                        name = "KGE", 
#                        direction = -1) +
#   geom_text(aes(label = sprintf("%.2f", 
#                                 kge_revise)), 
#             color = "grey", 
#             size = 2.5) +
#   theme_bw(base_size=20) +
#   theme(axis.text.x = element_text(angle = 45, 
#                                    hjust = 1)) +
#   labs(y = "Year",
#        x='Year Excluded') +
#   # facet_wrap(~source,
#   #            scales = 'free_x',
#   #            labeller = as_labeller(c("grid" = "Gridded", 
#   #                                     "statn" = "Station"))) +
#   theme(
#     axis.text.x = element_text(angle = 45, 
#                                hjust = 1),
#     legend.position = 'none',
#     legend.text = element_text(size = 14),
#     legend.title = element_text(size = 14),
#     legend.key.width = unit(.75, "cm"),
#     panel.grid = element_blank(),
#     panel.background = element_rect(fill = "white"),
#     strip.background = element_blank(),
#     text = element_text(color = "black"),
#     axis.title = element_text(color = "black"),
#     axis.text = element_text(color = "black")
#   ) 
# 
# grid_kge_plot
# 
# 
# 
# #003f5c
# #58508d
# #bc5090
# #ff6361
# #ffa600
# 
# ggsave('/Users/megansears/Documents/Repos/fourmile/figures/kge_heatmap_grid.png',
#        dpi=600,
#        width = 10,
#        height = 6)


```

```{r}

flow_plot_updated <- flow_plot_updated %>%
  mutate(kge_revise_bins = cut(kge,
                               breaks = c(-Inf, 0.0, 0.2, 0.4, 0.6, 0.8, 1),
                               include.lowest = TRUE,
                               labels = c("< 0.0","0.0-0.2", "0.2-0.4", "0.4-0.6", "0.6-0.8", "> 0.8")))


# grid_kge_plot <- flow_plot_updated %>%
#   filter(source == 'grid') %>% 
# ggplot(., aes(x = year_excluded, 
#               y = year, 
#               fill = kge_revise_bins)) +
#   geom_tile(color = "white") +
#   # scale_fill_manual(values = color_palette) +
# paletteer::scale_fill_paletteer_d("PNWColors::Anemone") +
#   geom_text(aes(label = sprintf("%.2f", 
#                                 kge)), 
#             color = "black", 
#             size = 3) +
#   theme_bw(base_size=20) +
#   theme(axis.text.x = element_text(angle = 45, 
#                                    hjust = 1)) +
#   labs(y = "Year",
#        x='Year Excluded',
#        fill = 'KGE') +
#   theme(
#     axis.text.x = element_text(angle = 45, 
#                                hjust = 1),
#     legend.position = 'bottom',
#     legend.text = element_text(size = 14),
#     legend.title = element_text(size = 14),
#     legend.key.width = unit(.75, "cm"),
#     panel.grid = element_blank(),
#     panel.background = element_rect(fill = "white"),
#     strip.background = element_blank(),
#     text = element_text(color = "black"),
#     axis.title = element_text(color = "black"),
#     axis.text = element_text(color = "black"),
#     plot.margin = margin(t = 0, r = 10, b = 10, l = 10),
#     legend.margin = margin(t = -8, b = -4, unit = "pt")
#   ) + ggtitle('a. Gridded')
# 
# grid_kge_plot
# 
# ggsave('/Users/megansears/Documents/Repos/fourmile/figures/kge_heatmap_grid_basic.png',
#        dpi=600,
#        width = 10,
#        height = 6)

# mean_kge <- mean(flow_plot_updated$kge, na.rm = TRUE)
# 
# # Boxplot with mean line
# boxplot_x <- flow_plot_updated %>%
#   filter(source == "grid") %>%
#   ggplot(aes(x=source, y = kge)) +
#   geom_hline(yintercept = mean_kge, color = "black", linetype = "dashed", size = 0.5) +
#   geom_boxplot(outliers=F, fill = "grey", color = "black") +
#   theme_bw(base_size=16) +
#   theme(
#     panel.grid = element_blank(),
#     panel.background = element_rect(fill = "white"),
#     strip.background = element_blank(),
#     text = element_text(color = "black"),
#     axis.title = element_text(color = "black"),
#     axis.text = element_text(color = "black"),
#     axis.title.y = element_blank(),
#     axis.title.x = element_blank(),
#     axis.text.x = element_blank(),
#     axis.ticks.x = element_blank(),
#     plot.margin = margin(t = 10, r = 5, b = 76, l = 5)  # Adjust margins if necessary
#   ) +
#    scale_y_continuous(position = "right") 
# 
# boxplot_x
# 
# plot_grid(grid_kge_plot,boxplot_x, ncol = 2, 
#           rel_widths = c(3, 0.75))
# 
# 
# ggsave('/Users/megansears/Documents/Repos/fourmile/figures/kge_heatmap_grid.png',
#        dpi=600,
#        width = 10,
#        height = 6)
# 
# ######
# 
# boxplot_yrex <- flow_plot_updated %>%
#   filter(source == "grid") %>%
#   ggplot(aes(x=year_excluded, y = kge)) +
#   geom_boxplot(outliers=F, fill = "grey", 
#                color = "black",
#                width = 0.5) +
#   theme_bw(base_size=20) +
#   labs(y= 'KGE') +
#   theme(
#     panel.grid = element_blank(),
#     panel.background = element_rect(fill = "white"),
#     strip.background = element_blank(),
#     text = element_text(color = "black"),
#     axis.title = element_text(color = "black"),
#     axis.text = element_text(color = "black"),
#     #axis.title.y = element_blank(),
#     axis.title.x = element_blank(),
#     axis.text.x = element_blank(),
#     axis.ticks.x = element_blank(),
#     plot.margin = margin(t = 10, r = 10, b = 0, l = 24)  # Adjust margins if necessary
#   )
#   
# boxplot_yrex
# 
# plot_grid(NULL, boxplot_yrex, NULL, grid_kge_plot, ncol = 1,
#            rel_heights = c(0.1, 1, -0.00005, 2))
# 
# ggsave('/Users/megansears/Documents/Repos/fourmile/figures/kge_heatmap_grid_test.png',
#        dpi=600,
#        width = 10,
#        height = 6)
# 
# statn_kge_plot <- flow_plot_updated %>%
#   filter(source == 'statn') %>% 
# ggplot(., aes(x = year_excluded, 
#               y = year, 
#               fill = kge_revise_bins)) +
#   geom_tile(color = "white") +
#   facet_wrap(~source) +
#   # scale_fill_manual(values = color_palette) +
# paletteer::scale_fill_paletteer_d("PNWColors::Anemone") +
#   geom_text(aes(label = sprintf("%.2f", 
#                                 kge)), 
#             color = "black", 
#             size = 3) +
#   theme_bw(base_size=20) +
#   theme(axis.text.x = element_text(angle = 45, 
#                                    hjust = 1)) +
#   labs(y = "Year",
#        x='Year Excluded',
#        fill = 'KGE') +
#   theme(
#     axis.text.x = element_text(angle = 45, 
#                                hjust = 1),
#     legend.position = 'bottom',
#     legend.text = element_text(size = 14),
#     legend.title = element_text(size = 14),
#     legend.key.width = unit(.75, "cm"),
#     panel.grid = element_blank(),
#     panel.background = element_rect(fill = "white"),
#     strip.background = element_blank(),
#     text = element_text(color = "black"),
#     axis.title = element_text(color = "black"),
#     axis.text = element_text(color = "black"),
#     plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
#     legend.margin = margin(t = -8, b = -4, unit = "pt"),
#     # axis.title.y = element_blank(),
#     # axis.text.y = element_blank(),
#     # axis.ticks.y = element_blank()
#   )
# 
# statn_kge_plot
# 
# ggsave('/Users/megansears/Documents/Repos/fourmile/figures/kge_heatmap_statn_basic.png',
#        dpi=600,
#        width = 10,
#        height = 6)

# facet wrap the plots
new_facet_titles <- c(
  "grid" = "Gridded",
  "statn" = "Station"
)


both_kge_plot <- flow_plot_updated %>%
  ggplot(., aes(x = year, 
              y = year_excluded, 
              fill = kge_revise_bins)) +
  geom_tile(color = "white") +
  facet_wrap(~source, labeller = labeller(source = new_facet_titles)) +
  #paletteer::scale_fill_paletteer_d("PNWColors::Anemone") +
  # paletteer::scale_fill_paletteer_d(
  # "PNWColors::Anemone", 
  # guide = guide_legend(nrow = 1),
  # direction = -1) +
   scale_fill_manual(values = c(
    "< 0.0" = "#DCBE9BFF", 
    "0.0-0.2" = "#EFDDCFFF",
    "0.2-0.4" = "#F1F4EEFF",
    "0.4-0.6" = "#72E1E1FF",
    "0.6-0.8" = "#11C2B5FF",
    "> 0.8" = "#009474FF"),
    guide = guide_legend(nrow = 1)) +
  geom_text(aes(label = sprintf("%.2f", 
                                kge)), 
            color = "black", 
            size = 3) +
  theme_bw(base_size=18) +
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1)) +
  labs(y = "Year excluded",
       x='Year',
       fill = 'KGE') +
  theme(
    axis.text.x = element_text(angle = 45, 
                               hjust = 1),
    legend.position = 'bottom',
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.key.width = unit(.6, "cm"),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    legend.margin = margin(t = -8, b = -4, unit = "pt"),
  )

both_kge_plot

ggsave('/Users/megansears/Documents/Repos/fourmile/figures/kge_heatmap_both_basic.png',
       dpi=600,
       width = 10,
       height = 6)

```

## Pbias

### Overall pbias

```{r pbias overall, echo = FALSE, message = FALSE, warning = FALSE}

flow_pbias_all <- flow %>%
  summarize(
    grid2011 = pbias(grid_2011, obs),
            grid2012 = pbias(grid_2012, obs),
            grid2013 = pbias(grid_2013, obs),
            grid2014 = pbias(grid_2014, obs),
            grid2015 = pbias(grid_2015, obs),
            grid2016 = pbias(grid_2016, obs),
            grid2017 = pbias(grid_2017, obs),
            grid2018 = pbias(grid_2018, obs),
            grid2019 = pbias(grid_2019, obs),
            grid2020 = pbias(grid_2020, obs),
            gridall = pbias(grid_all, obs),
            statn2011 = pbias(statn_2011, obs),
            statn2012 = pbias(statn_2012, obs),
            statn2013 = pbias(statn_2013, obs),
            statn2014 = pbias(statn_2014, obs),
            statn2015 = pbias(statn_2015, obs),
            statn2016 = pbias(statn_2016, obs),
            statn2017 = pbias(statn_2017, obs),
            statn2018 = pbias(statn_2018, obs),
            statn2019 = pbias(statn_2019, obs),
            statn2020 = pbias(statn_2020, obs),
            statnall = pbias(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

flow_pbias_all <- flow_pbias_all %>%
  pivot_longer(everything()) %>%
  arrange(abs(value))

kable(flow_pbias_all) %>%
  kable_styling(full_width = F)

```


### Pbias by year

```{r pbias by year, echo = FALSE, message = FALSE, warning = FALSE}

flow_year <- flow %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(
    grid2011 = pbias(grid_2011, obs),
            grid2012 = pbias(grid_2012, obs),
            grid2013 = pbias(grid_2013, obs),
            grid2014 = pbias(grid_2014, obs),
            grid2015 = pbias(grid_2015, obs),
            grid2016 = pbias(grid_2016, obs),
            grid2017 = pbias(grid_2017, obs),
            grid2018 = pbias(grid_2018, obs),
            grid2019 = pbias(grid_2019, obs),
            grid2020 = pbias(grid_2020, obs),
            gridall = pbias(grid_all, obs),
            statn2011 = pbias(statn_2011, obs),
            statn2012 = pbias(statn_2012, obs),
            statn2013 = pbias(statn_2013, obs),
            statn2014 = pbias(statn_2014, obs),
            statn2015 = pbias(statn_2015, obs),
            statn2016 = pbias(statn_2016, obs),
            statn2017 = pbias(statn_2017, obs),
            statn2018 = pbias(statn_2018, obs),
            statn2019 = pbias(statn_2019, obs),
            statn2020 = pbias(statn_2020, obs),
            statnall = pbias(statn_all, obs)) %>%
    mutate_if(is.numeric,
            round,
            digits = 2)

flow_pbias <- flow_year %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'pbias') %>%
  pivot_wider(names_from = 'year', values_from = 'pbias')

flow_pbias %>%
  kable(.) %>%
  kable_styling()

flow_plot <- flow_year %>%
  pivot_longer(!year, names_to = 'model_run', values_to = 'pbias') %>%
  mutate(year = as.factor(year))

# add all to the plot below
pbias_all <- flow_pbias_all %>%
  mutate(year = 'All') %>%
  rename(model_run = name,
         pbias = value)

flow_plot_updated <- bind_rows(flow_plot, pbias_all)

ggplot(flow_plot_updated, aes(x = model_run, y = year, fill = pbias)) +
  geom_tile(color = "white") +
   scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0, name = "Pbias") +
  geom_text(aes(label = round(pbias, 2)), color = "black", size = 2.5) +
  theme_bw(base_size=20) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Year")

####
# pbias figure
flow_plot_updated <- flow_plot_updated %>% 
  mutate(source = case_when(
    grepl("grid", model_run) ~ "grid",
    grepl("statn", model_run) ~ "statn"),
    year_excluded = str_extract(model_run, "\\d{4}$")) %>%
  mutate(year_excluded = if_else(model_run %in% c('gridall',
                                                       'statnall'),
                                  'None', year_excluded))

# both_pbias_plot <- flow_plot_updated %>%
#   ggplot(., aes(x = year_excluded, 
#               y = year, 
#               fill = pbias)) +
#   geom_tile(color = "white") +
#   facet_wrap(~source, labeller = labeller(source = new_facet_titles)) +
#   #paletteer::scale_fill_paletteer_c("ggthemes::Gold-Purple Diverging") +
#   #paletteer::scale_fill_paletteer_c("grDevices::Red-Green") +
#   #paletteer::scale_fill_paletteer_c("grDevices::Purple-Green") +
#   paletteer::scale_fill_paletteer_c("grDevices::Green-Brown") +
#   #paletteer::scale_fill_paletteer_c("grDevices::Earth") +
#   geom_text(aes(label = sprintf("%.2f", 
#                                 pbias)), 
#             color = "black", 
#             size = 2.75) +
#   theme_bw(base_size=18) +
#   theme(axis.text.x = element_text(angle = 45, 
#                                    hjust = 1)) +
#   labs(y = "Year",
#        x='Year excluded',
#        fill = 'Pbias') +
#   theme(
#     axis.text.x = element_text(angle = 45, 
#                                hjust = 1),
#     legend.position = 'bottom',
#     legend.text = element_text(size = 14),
#     legend.title = element_text(size = 14),
#     legend.key.width = unit(.75, "cm"),
#     panel.grid = element_blank(),
#     panel.background = element_rect(fill = "white"),
#     strip.background = element_blank(),
#     text = element_text(color = "black"),
#     axis.title = element_text(color = "black"),
#     axis.text = element_text(color = "black"),
#     plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
#     legend.margin = margin(t = -8, b = -4, unit = "pt"),
#     # axis.title.y = element_blank(),
#     # axis.text.y = element_blank(),
#     # axis.ticks.y = element_blank()
#   )
# 
# both_pbias_plot
# 
# ggsave('/Users/megansears/Documents/Repos/fourmile/figures/pbias_heatmap_both_basic.png',
#        dpi=600,
#        width = 10,
#        height = 6)


# Compute max absolute value for symmetric limits
# put pbias into categories
pbiasCats <- flow_plot_updated %>%
  mutate(pbiasCat = case_when(
    abs(pbias) < 10 ~ 'Very good',
    abs(pbias) >= 10 & abs(pbias) < 15 ~ 'Good',
    abs(pbias) >= 15 & abs(pbias) < 25 ~ 'Satisfactory',
    abs(pbias) >= 25 ~ 'Unsatisfactory'),
    pbiasCat = factor(pbiasCat, levels = c("Unsatisfactory", 
                                           "Satisfactory", 
                                           "Good", 
                                           "Very good")))

write_csv(pbiasCats, '/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates/pbiasCats.csv')

both_pbias_plot <- pbiasCats %>%
  ggplot(aes(x = year, 
             y = year_excluded, 
             fill = pbiasCat)) +
  geom_tile(color = "white") +
  facet_wrap(~source, labeller = labeller(source = new_facet_titles)) +
   scale_fill_manual(values = c(
    "Unsatisfactory" = "#F1F4EEFF", 
    "Satisfactory" = "#EFDDCFFF",
    "Good" = "#72E1E1FF",
    "Very good" = "#009474FF"
  )) +
  geom_text(aes(label = sprintf("%.2f", pbias)), 
            color = "black", 
            size = 2.75) +
  theme_bw(base_size=18) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = 'bottom',
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.key.width = unit(1, "cm"),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    legend.margin = margin(t = -8, b = -4, unit = "pt")
  ) +
  labs(y = "Year excluded",
       x = 'Year',
       fill = '% bias')

both_pbias_plot

ggsave('/Users/megansears/Documents/Repos/fourmile/figures/pbias_heatmap_both_cats.png',
       dpi=600,
       width = 10,
       height = 6)


```

# RD and RG

- **Different units than streamflow (cms) and volume (m3)**
- **All in mm**

```{r rd and rg, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 14, fig.asp = 1, out.width = "100%"}

gw_gridall <- read_csv(here('38HRU_dec2024_updates/catchment_output/grid_all.csv'), skip = 3) %>%
  slice(-c(1,2)) %>%
  dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
  mutate(source = 'grid_all') %>%
  mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))


gw_statnall <- read_csv(here('38HRU_dec2024_updates/catchment_output/statn_all.csv'), skip = 3) %>%
  slice(-c(1,2)) %>%
  dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
  mutate(source = 'statn_all') %>%
  mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))

# gw_grid2011 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2011.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2011')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2012 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2012.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2012')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2013 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2013.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2013')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2014 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2014.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2014')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2015 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2015.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2015')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2016 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2016.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2016')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2017 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2017.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2017')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2018 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2018.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2018')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2019 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2019.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2019')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_grid2020 <- read_csv(here('38HRU_sept2013_updates/catchment_output/grid_2020.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'grid_2020')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2011 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2011.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2011')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2012 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2012.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2012')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2013 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2013.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2013')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2014 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2014.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2014')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2015 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2015.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2015')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2016 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2016.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2016')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2017 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2017.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2017')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2018 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2018.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2018')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2019 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2019.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2019')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))
#
# gw_statn2020 <- read_csv(here('38HRU_sept2013_updates/catchment_output/statn_2020.csv'), skip = 3) %>%
#   slice(-c(1,2)) %>%
#   dplyr::select(time, catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w) %>%
#   mutate(source = 'statn_2020')%>%
#   mutate(across(c(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w), as.numeric))

gw <- bind_rows(
  gw_gridall, gw_statnall
  # gw_grid2011, gw_grid2012,
  # gw_grid2013, gw_grid2014,
  # gw_grid2015, gw_grid2016,
  # gw_grid2017, gw_grid2018,
  # gw_grid2019, gw_grid2020,
  # gw_statn2011, gw_statn2012,
  # gw_statn2013, gw_statn2014,
  # gw_statn2015, gw_statn2016,
  # gw_statn2017, gw_statn2018,
  # gw_statn2019, gw_statn2020
) %>%
  mutate(date = mdy(time),
         year = year(date)) %>%
  arrange(date)

# ggplot(gw, aes(x=date, color = source)) +
#   geom_line(aes(y=catchmentRD1_w), size =1) +
#   facet_wrap(~year, scales="free", ncol = 2) +
#   scale_x_date(labels = date_format("%b")) +
#   ggtitle('RD1') +
#   theme(text = element_text(size = 20)) +
#   labs(y = 'RD1 (mm)') +
#   theme_bw(base_size=20)
# 
# ggplot(gw, aes(x=date, color = source)) +
#   geom_line(aes(y=catchmentRD2_w), size =1) +
#   facet_wrap(~year, scales = 'free', ncol = 2) +
#   scale_x_date(labels = date_format("%b")) +
#   ggtitle('RD2') +
#   theme(text = element_text(size = 20))+
#   labs(y = 'RD2 (mm)')+
#   theme_bw(base_size=20)
# 
# ggplot(gw, aes(x=date, color = source)) +
#   geom_line(aes(y=catchmentRG1_w), size =1) +
#   facet_wrap(~year, scales = 'free', ncol = 2) +
#   scale_x_date(labels = date_format("%b")) +
#   ggtitle('RG1') +
#   theme(text = element_text(size = 20)) +
#   labs(y = 'RG1 (mm)')+
#   theme_bw(base_size=20)
# 
# ggplot(gw, aes(x=date, color = source)) +
#   geom_line(aes(y=catchmentRG2_w), size =1) +
#   facet_wrap(~year, scales = 'free', ncol=2) +
#   scale_x_date(labels = date_format("%b")) +
#   ggtitle('RG2') +
#   theme(text = element_text(size = 20))+
#   labs(y = 'RG2 (mm)')+
#   theme_bw(base_size=20)

gw <- gw %>%
  arrange(date) %>%
  group_by(year, source) %>%
  mutate(RD1cumsum = cumsum(catchmentRD1_w),
         RD2cumsum = cumsum(catchmentRD2_w),
         RG1cumsum = cumsum(catchmentRG1_w),
         RG2cumsum = cumsum(catchmentRG2_w))

# ggplot(gw, aes(x=date, color = source)) +
#   geom_line(aes(y=RD1cumsum), size =1) +
#   facet_wrap(~year, scales = 'free', ncol=2) +
#   scale_x_date(labels = date_format("%b")) +
#   ggtitle('Cumulative RD1 (mm)') +
#   theme(text = element_text(size = 20)) +
#   theme_bw(base_size=20)
# 
# ggplot(gw, aes(x=date, color = source)) +
#   geom_line(aes(y=RD2cumsum), size = 1) +
#   facet_wrap(~year, scales = 'free', ncol=2) +
#   scale_x_date(labels = date_format("%b")) +
#   ggtitle('Cumulative RD2 (mm)') +
#   theme(text = element_text(size = 20))+
#   theme_bw(base_size=20)
# 
# ggplot(gw, aes(x=date, color = source)) +
#   geom_line(aes(y=RG1cumsum), size  = 1) +
#   facet_wrap(~year, scales = 'free', ncol = 2) +
#   scale_x_date(labels = date_format("%b")) +
#   ggtitle('Cumulative RG1 (mm)') +
#   theme(text = element_text(size = 20))+
#   theme_bw(base_size=20)
# 
# ggplot(gw, aes(x=date, color = source)) +
#   geom_line(aes(y=RG2cumsum), size =1) +
#   facet_wrap(~year, scales = 'free', ncol = 2) +
#   scale_x_date(labels = date_format("%b")) +
#   ggtitle('Cumulative RG2 (mm)') +
#   theme(text = element_text(size = 20))+
#   theme_bw(base_size=20)

```


```{r rd and rg sums, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 22, fig.asp = 1.5, out.width = "100%"}

##################
# all 4 with facets

gw %>%
  filter(source == 'grid_all') %>%
  ggplot(aes(x=date)) +
  geom_line(aes(y=RG2cumsum, color = 'cumulative RG2'), size =1) +
  geom_line(aes(y=RG1cumsum, color = 'cumulative RG1'), size =1) +
  geom_line(aes(y=RD1cumsum, color = 'cumulative RD1'), size =1) +
  geom_line(aes(y=RD2cumsum, color = 'cumulative RD2'), size =1) +
  scale_x_date(labels = date_format("%b")) +
  facet_wrap(~year, scales = 'free_x', ncol=3) +
  ggtitle('Grid Cumulative RD and RG (mm)') +
  #theme(text = element_text(size = 24)) +
  theme_bw(base_size=14) +
  labs(y='cumulative sum')

gw %>%
  filter(source == 'statn_all') %>%
  ggplot(aes(x=date)) +
  geom_line(aes(y=RG2cumsum, color = 'cumulative RG2'), size =1) +
  geom_line(aes(y=RG1cumsum, color = 'cumulative RG1'), size =1) +
  geom_line(aes(y=RD1cumsum, color = 'cumulative RD1'), size =1) +
  geom_line(aes(y=RD2cumsum, color = 'cumulative RD2'), size =1) +
  scale_x_date(labels = date_format("%b")) +
  facet_wrap(~year, scales = 'free_x', ncol=3) +
  ggtitle('Statn Cumulative RD and RG (mm)') +
  #theme(text = element_text(size = 24)) +
  theme_bw(base_size=14) +
  labs(y='cumulative sum')

# look at 2016, best performing year 
example <- gw %>%
  filter(year == 2016) %>%
  ungroup() %>% 
  dplyr::select(date, source,
         RD1cumsum,
         RD2cumsum,
         RG1cumsum,
         RG2cumsum) %>%
  pivot_longer(!c(date,source), names_to='flow_type',
               values_to='flow_cms') %>%
  mutate(source = if_else(source == 'grid_all',
                          'Gridded',
                          'Station'))

facet_labels <- c('RD1cumsum' = 'Surface runoff',
                  'RD2cumsum' = 'Interflow',
                  'RG1cumsum' = 'Fast groundwater',
                  'RG2cumsum' = 'Slow groundwater')

example_yr <- ggplot(example,
       aes(x=date, y = flow_cms, color=source)) +
  geom_line() +
  facet_wrap(~flow_type, 
             scales = 'free_y',
             labeller = labeller(flow_type = facet_labels)) +
   geom_line(size=1, alpha=0.7) +  
  scale_color_manual(values = c("#0047AB", "orange")) +
    scale_x_date(date_labels = "%b %Y", 
               date_breaks = "2 month") +
  labs(x=element_blank(),
       y='mm of water') +
  theme_bw(base_size = 16) +
  theme(
    legend.position = c(0.94, 0.1),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    plot.margin = margin(t = 10, r = 20, b = 10, l = 10)
  )

example_yr

ggsave('/Users/megansears/Documents/Repos/fourmile/figures/2016_flowcumulative.png',
       dpi=600,
       width=14,
       height=8)

```


```{r gw boxplot, echo = FALSE, message = FALSE, warning = FALSE}

gw_maxcumsum <- gw %>%
  group_by(source, year) %>%
  summarize(yr_cum_RD1 = max(RD1cumsum),
            yr_cum_RD2 = max(RD2cumsum),
            yr_cum_RG1 = max(RG1cumsum),
            yr_cum_RG2 = max(RG2cumsum)) %>%
  mutate(year = as.factor(year)) %>%
  pivot_longer(!c(year, source), names_to = 'flow_type', values_to = 'flow_cms') %>%
  mutate(source = if_else(source == 'grid_all',
                          'Gridded',
                          'Station'))


ggplot(gw_maxcumsum, aes(x = flow_type, y = flow_cms, fill = source)) +
  geom_boxplot(position = position_dodge(1)) +
  #geom_point(position=position_jitterdodge(),alpha=0.3) +
  scale_y_log10() +
  ggtitle('Annual sum') +
  labs(y = 'mm of water') + theme_bw(base_size=20) # this plot doesnt show lower values (eg rd1)
# i tried with log scale on y and it looks really bad so going with facet below


facet_labels <- c('yr_cum_RD1' = 'Surface runoff',
                  'yr_cum_RD2' = 'Interflow',
                  'yr_cum_RG1' = 'Fast groundwater',
                  'yr_cum_RG2' = 'Slow groundwater')

flow_box <- ggplot(gw_maxcumsum, aes(x = flow_type, y = flow_cms, fill = source)) +
  geom_boxplot(position = position_dodge(1),
               outliers=F) + # need to note 1 outlier is removed from RD1 grid and statn (2013 flood) ****
  stat_compare_means(data = gw_maxcumsum %>% 
                       filter(flow_type != "yr_cum_RD1"),
                     aes(group = source),
                     method = "wilcox.test",
                     label = "p.signif",
                     hide.ns = T,
                     paired = F,
                     size = 7) +
  facet_wrap(~flow_type, 
             scales = 'free',
             labeller = labeller(flow_type = facet_labels)) +
  labs(y = 'mm of water') + 
  theme_bw(base_size=20) +
  scale_fill_manual(values = c("#0047AB", "orange")) +
  theme(
    legend.position = c(0.93, 0.36),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.15)))

flow_box

ggsave('./figures/water_partition_boxplots.png',
       dpi=600)


# want to see distribution
ggplot(gw_maxcumsum, aes(x = flow_cms, fill = source)) +
  geom_density(alpha = 0.6, adjust = 1.2) +  # Adjust smoothness with `adjust`
  facet_wrap(~flow_type, 
             scales = 'free', 
             labeller = labeller(flow_type = facet_labels)) +
  labs(x = "Flow (cms)", y = "Density") + 
  theme_bw(base_size = 20) +
  scale_fill_manual(values = c("#0047AB", "orange")) +
  theme(
    legend.position = 'top',
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black")
  )

flow_summ <- gw_maxcumsum %>%
  #filter(!year == 2013) %>%
  group_by(source, flow_type) %>%
  summarize(min = min(flow_cms),
            max = max(flow_cms))

```

### RD and RG stats

```{r}

model <-aov(flow_cms ~ source * flow_type, 
            data = gw_maxcumsum)
    
# Tukey HSD
tukey_test <- TukeyHSD(model)

tukey_test

library(multcompView)
tukey_letters <- multcompLetters4(model, tukey_test)

tukey_letters$`source:flow_type`$Letters

# make a vector of the letters
letters_vector <- c("a", "b", "b", "c", "c", "c", "c", "c")

gw_maxcumsum <- gw_maxcumsum %>%
  mutate(letter = case_when(
    source == "Gridded" & flow_type == "yr_cum_RG1" ~ letters_vector[1],
    source == "Station" & flow_type == "yr_cum_RG1" ~ letters_vector[2],
    source == "Station" & flow_type == "yr_cum_RD2" ~ letters_vector[3],
    source == "Gridded" & flow_type == "yr_cum_RD1" ~ letters_vector[4],
    source == "Station" & flow_type == "yr_cum_RD1" ~ letters_vector[5],
    source == "Gridded" & flow_type == "yr_cum_RD2" ~ letters_vector[6],
    source == "Gridded" & flow_type == "yr_cum_RG2" ~ letters_vector[7],
    source == "Station" & flow_type == "yr_cum_RG2" ~ letters_vector[8]
  ))

# now make the same figure as above but with letters
facet_labels <- c('yr_cum_RD1' = 'Surface runoff',
                  'yr_cum_RD2' = 'Interflow',
                  'yr_cum_RG1' = 'Fast groundwater',
                  'yr_cum_RG2' = 'Slow groundwater')

perf <- read_csv('/Users/megansears/Documents/Repos/fourmile/38HRU_dec2024_updates/nse_pbias_grid_statn_all.csv') %>%
  mutate(year = as.factor(year))

gw_maxcumsum <- left_join(gw_maxcumsum,
                          perf,
                          by = c('source',
                                 'year'))

gw_maxcumsum <- gw_maxcumsum %>%
  mutate(flow_cms = if_else(flow_type == 'yr_cum_RD1' &
                                flow_cms > 48,
                              NA,
                              flow_cms))

gw_maxcumsum_letters <- gw_maxcumsum %>%
  group_by(source, flow_type) %>%
  mutate(max = max(flow_cms)) %>%
  distinct(flow_type, source, .keep_all = TRUE) %>%
    mutate(max = if_else((flow_type == 'yr_cum_RD1' & 
                           source == 'Gridded'),
                         3.5, max)) %>%
    mutate(max = if_else((flow_type == 'yr_cum_RD1' & 
                           source == 'Station'),
                         1.3, max)) %>%
  mutate(y_text = max * 1.06)

flow_box <- ggplot(gw_maxcumsum, aes(x = source, y = flow_cms, fill = source)) +
  geom_boxplot(outliers=F,width=0.7) + # need to note 1 outlier is removed from RD1 grid and statn (2013 flood) ****
  geom_jitter(
    aes(shape = both),
    position = position_jitter(width = 0.25),
    size = 2.5,
    alpha = 0.7,
    stroke = 1,
    color = "black") +
  scale_shape_manual(values = c(
  "NSE + % bias unsatisfactory" = 4,
  "NSE + % bias satisfactory" = 16,
  "NSE satisfactory" = 1)) +
  geom_text(data = gw_maxcumsum_letters, 
            aes(label=letter,
                y=y_text),
            position = position_dodge(width = 0.97),
            size = 6, 
            vjust = 0) + 
  facet_wrap(~flow_type, 
             scales = 'free',
             labeller = labeller(flow_type = facet_labels)) +
  labs(y = 'mm of water') + 
  theme_bw(base_size=20) +
  scale_fill_manual(values = c("#0047AB", "orange"), guide = 'none') +
  theme(
    #legend.position = c(0.94, 0.36),
    legend.position = 'bottom',
    legend.text = element_text(size = 16),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    axis.title.x = element_blank(),
    legend.spacing = unit(0.1, "lines"),
    legend.margin = margin(t = -8, r = 0, b = -2, l = 0)) +
    #axis.text.x = element_blank(),
    #axis.ticks.x = element_blank()) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15))) 

flow_box

ggsave('./figures/water_partition_boxplots.png',
       dpi=600,
       width = 12,
       height = 8)

# cowplot
plot_grid(
  flow_box,
  example_yr,
  ncol = 1,
  labels = c("a", "b"),       # Add labels
  label_size = 18,            # Optional: adjust the label size
  label_fontface = "bold"     # Optional: make labels bold
)

ggsave('/Users/megansears/Documents/Repos/fourmile/figures/water_partition_combine_pts.png',
       dpi=600,
       width=12,
       height=12)



```


### RD and RG by season

- January-February = baseflow_winter
- March-June = snowmelt
- July-August = Monsoon
- September-December = Baseflow_fall


```{r flow season, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 12, fig.asp = 0.75, out.width = "100%"}

#group by season and get max sums by season
flow_season <- gw %>%
  dplyr::select(catchmentRD1_w, catchmentRD2_w, catchmentRG1_w, catchmentRG2_w, date, year, source) %>%
  mutate(month = month(date)) %>%
  mutate(season = case_when(month %in% c(3,4,5,6) ~ 'snowmelt',
                            month %in% c(7,8) ~ 'monsoon',
                            month %in% c(9,10,11,12) ~ 'baseflow_fall',
                            month %in% c(1,2) ~ 'baseflow_winter')) %>%
  group_by(source, year, season) %>%
  mutate(yr_season_RD1 = cumsum(catchmentRD1_w),
            yr_season_RD2 = cumsum(catchmentRD2_w),
            yr_season_RG1 = cumsum(catchmentRG1_w),
            yr_season_RG2 = cumsum(catchmentRG2_w)) %>%
  summarize(sumRD1 = max(yr_season_RD1),
            sumRD2 = max(yr_season_RD2),
            sumRG1 = max(yr_season_RG1),
            sumRG2 = max(yr_season_RG2)) %>%
            pivot_longer(!c(year, source, season), names_to = 'flow_type', values_to = 'mm_water')


flow_season %>%
  ggplot(aes(x = flow_type, y = mm_water, fill = source)) +
  geom_boxplot(position = position_dodge(1)) +
  #geom_point(position=position_jitterdodge(),alpha=0.3) +
  #geom_point(aes(color = source)) +
  facet_wrap(~season) +
  ggtitle('RD/RG sums (mm)') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(text = element_text(size = 20)) +
  labs(y = 'RD/RG sums (mm)')


flow_season %>%
  ggplot(aes(x = flow_type, y = mm_water, fill = source)) +
  geom_boxplot(position = position_dodge(1)) +
  geom_point(position=position_jitterdodge(),alpha=0.3) +
  #geom_point(aes(color = source)) +
  facet_wrap(~season + flow_type, scales = 'free') +
  ggtitle('Seasonal sums') +
  theme_bw() +
  theme(text = element_text(size = 20)) +
  labs(y = 'RD/RG seasonal sums (mm)')

```

# Example year

```{r}

# 2016 hydrograph
flowEg <- flow_pivot %>%
  filter(year %in% c(2016)) %>%
  ggplot(aes(x = date,
             y = q_m3s, 
             color = cal_run,
             linetype = cal_run)) + 
  geom_line(size = 1, alpha = 1) + 
  theme_bw(base_size = 20) +
  scale_color_manual(values = c("Gridded" = "#0047AB", 
                                "Observed" = "black", 
                                "Station" = "orange")) +
  scale_linetype_manual(values = c("Gridded" = "solid",
                                   "Observed" = "dashed", 
                                   "Station" = "solid")) +
  labs(x = element_blank(),
       y = "Streamflow (cms)") +
   scale_x_date(date_labels = "%b",
               date_breaks = "1 month") +
  theme(
    legend.position = c(0.9, 0.85),
    legend.text = element_text(size = 14),
    legend.key.width = unit(2, "lines"),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    plot.margin = margin(t = 2, r = 20, b = 2, l = 10)
  )

flowEg

# 2016 flow partition
example <- gw %>%
  filter(year == 2016) %>%
  ungroup() %>% 
  dplyr::select(date, source,
         RD1cumsum,
         RD2cumsum,
         RG1cumsum,
         RG2cumsum) %>%
  pivot_longer(!c(date,source), names_to='flow_type',
               values_to='flow_cms') %>%
  mutate(source = if_else(source == 'grid_all',
                          'Gridded',
                          'Station'))

facet_labels <- c('yr_cum_RD1' = 'Surface runoff',
                  'yr_cum_RD2' = 'Interflow',
                  'yr_cum_RG1' = 'Fast groundwater',
                  'yr_cum_RG2' = 'Slow groundwater')

example_yr <- ggplot(example,
       aes(x=date, y = flow_cms, color=source)) +
  geom_line() +
  facet_wrap(~flow_type, 
             scales = 'free_y',
             labeller = labeller(flow_type = facet_labels)) +
   geom_line(size=1, alpha=0.7) +  
  scale_color_manual(values = c("#0047AB", "orange")) +
    scale_x_date(date_labels = "%b", 
               date_breaks = "2 month") +
  labs(x=element_blank(),
       y='mm of water') +
  theme_bw(base_size = 16) +
  theme(
    legend.position = 'none',
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    plot.margin = margin(t = 2, r = 20, b = 10, l = 10)
  )

example_yr

plot_grid(flowEg,
          example_yr,
          ncol=1)

ggsave('/Users/megansears/Documents/Repos/fourmile/figures/2016_all_flow.png',
       dpi=600,
       width=10,
       height=8)

```

